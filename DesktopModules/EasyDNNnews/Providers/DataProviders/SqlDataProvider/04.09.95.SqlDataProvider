/****** Object:  Table [dbo].[EasyDNNNewsTreeView]    Script Date: 10/25/2012 09:43:53 ******/
/****** Object:  Table [dbo].[EasyDNNnewsWidgets]    Script Date: 10/25/2012 09:43:53 ******/
/****** Object:  StoredProcedure [dbo].[EasyDNNNewsGetItemsPerCategory]    Script Date: 10/22/2012 14:36:45 ******/
/****** Object:  StoredProcedure [dbo].[EasyDNNNewsGetItemsForTreeView]    Script Date: 10/22/2012 14:36:45 ******/

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[EasyDNNNewsTreeView]') AND type in (N'U'))
BEGIN
CREATE TABLE [dbo].[EasyDNNNewsTreeView](
	[ModuleID] [int] NOT NULL,
	[SharingPortalID] [int] NULL,
	[Theme] [nvarchar](250) NOT NULL,
	[ThemeStyle] [nvarchar](250) NOT NULL,
	[ShowRssLink] [bit] NOT NULL,
	[ShowAllCategories] [bit] NOT NULL,
	[ExpandAllCategories] [bit] NOT NULL,
	[AutoAddChildCategories] [bit] NOT NULL,
	[OpenInModuleID] [int] NOT NULL,
	[PermissionSource] [tinyint] NOT NULL,
	[PermissionSourceID] [int] NOT NULL,
	[DisplayAllAuthors] [bit] NOT NULL,
	[DisplayHeader] [bit] NOT NULL,
	[IsSocialInstance] [bit] NOT NULL,
	[PassAuthorUserID] [bit] NOT NULL,
	[HideUnlocalizedItems] [bit] NOT NULL,
	[ShowArticles] [bit] NOT NULL,
	CONSTRAINT [PK_EasyDNNNewsTreeView] PRIMARY KEY CLUSTERED ( [ModuleID] ASC )WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF)
)
END
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[EasyDNNnewsWidgets]') AND type in (N'U'))
BEGIN
CREATE TABLE [dbo].[EasyDNNnewsWidgets](
	[ModuleID] [int] NOT NULL,
	[PortalID] [int] NOT NULL,
	[ViewControlID] [int] NOT NULL,
	CONSTRAINT [PK_EasyDNNnewsWidgets] PRIMARY KEY CLUSTERED  ([ModuleID] ASC) WITH (STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF)
)
END
GO
IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_EasyDNNnewsWidgets_Modules]') AND parent_object_id = OBJECT_ID(N'[dbo].[EasyDNNnewsWidgets]'))
ALTER TABLE [dbo].[EasyDNNnewsWidgets]  WITH CHECK ADD  CONSTRAINT [FK_EasyDNNnewsWidgets_Modules] FOREIGN KEY([ModuleID])
REFERENCES {databaseOwner}{objectQualifier}Modules ([ModuleID]) ON DELETE CASCADE
GO
IF  EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_EasyDNNnewsWidgets_Modules]') AND parent_object_id = OBJECT_ID(N'[dbo].[EasyDNNnewsWidgets]'))
ALTER TABLE [dbo].[EasyDNNnewsWidgets] CHECK CONSTRAINT [FK_EasyDNNnewsWidgets_Modules]
GO
IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_EasyDNNnewsWidgets_Portals]') AND parent_object_id = OBJECT_ID(N'[dbo].[EasyDNNnewsWidgets]'))
ALTER TABLE [dbo].[EasyDNNnewsWidgets]  WITH CHECK ADD  CONSTRAINT [FK_EasyDNNnewsWidgets_Portals] FOREIGN KEY([PortalID])
REFERENCES {databaseOwner}{objectQualifier}Portals ([PortalID]) ON DELETE CASCADE
GO
IF  EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_EasyDNNnewsWidgets_Portals]') AND parent_object_id = OBJECT_ID(N'[dbo].[EasyDNNnewsWidgets]'))
ALTER TABLE [dbo].[EasyDNNnewsWidgets] CHECK CONSTRAINT [FK_EasyDNNnewsWidgets_Portals]
GO
IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_EasyDNNNewsTreeView_Modules]') AND parent_object_id = OBJECT_ID(N'[dbo].[EasyDNNNewsTreeView]'))
ALTER TABLE [dbo].[EasyDNNNewsTreeView]  WITH CHECK ADD  CONSTRAINT [FK_EasyDNNNewsTreeView_Modules] FOREIGN KEY([ModuleID])
REFERENCES {databaseOwner}{objectQualifier}Modules ([ModuleID]) ON DELETE CASCADE
GO
IF  EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_EasyDNNNewsTreeView_Modules]') AND parent_object_id = OBJECT_ID(N'[dbo].[EasyDNNNewsTreeView]'))
ALTER TABLE [dbo].[EasyDNNNewsTreeView] CHECK CONSTRAINT [FK_EasyDNNNewsTreeView_Modules]
GO

/****** Object:  StoredProcedure [dbo].[EasyDNNNewsGetItemsForTreeView]    Script Date: 04/26/2013 09:40:53 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[EasyDNNNewsGetItemsForTreeView]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[EasyDNNNewsGetItemsForTreeView]
GO
/****** Object:  StoredProcedure [dbo].[EasyDNNNewsGetItemsPerCategory]    Script Date: 04/26/2013 09:40:53 ******/
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[EasyDNNNewsGetItemsPerCategory]') AND type in (N'P', N'PC'))
DROP PROCEDURE [dbo].[EasyDNNNewsGetItemsPerCategory]
GO
/****** Object:  StoredProcedure [dbo].[EasyDNNNewsGetItemsPerCategory]    Script Date: 04/26/2013 09:40:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[EasyDNNNewsGetItemsPerCategory]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'CREATE PROCEDURE [dbo].[EasyDNNNewsGetItemsPerCategory]
	@PortalID int,
	@UserID int,
	@MenuModuleID int,
	@DefaultTabID int,
    @DefaultModuleID int,
	@CurrentDate DateTime,
	@AdminOrSuperUser bit  = 0,
	@CountItems bit = 0,
	@IsSocialInstance bit = 0,
	@FilterByDNNUserID int = 0, -- filter by some UserID / not current user ID
	@FilterByDNNGroupID int = 0, -- filter by DNNGroup/RoleID / not profile GroupID
	@LocaleCode nvarchar(20) = '''',	
	@Perm_ViewAllCategores bit = 1, -- ako je permsource 0 onda je ovo default 1
	@ShowAllAuthors bit = 1, -- filter postavka menija
	@CategoryFilterType tinyint = 0, --0 All categories, 1 - Selection, 2 - AutoAdd
	@HideUnlocalizedItems bit = 0,
	@OrderBy nvarchar(20) = ''PublishDate DESC'',
	@EditOnlyAsOwner bit = 0, -- news settings
	@PermissionSettingsSource tinyint = 0, -- None, 1 - portal, 2 - module
	@PermissionsModuleID int = 0 -- NewsModuleID
AS
SET NOCOUNT ON;
DECLARE @UserCanApprove bit;
SET @UserCanApprove = 0;
DECLARE @Perm_EditAllCategores bit;
SET @Perm_EditAllCategores = 0;
DECLARE @ModuleID int;
SET @ModuleID = @MenuModuleID;
DECLARE @EditPermission tinyint;
SET @EditPermission = 0;
DECLARE @UserInRoles table (RoleID int NOT NULL PRIMARY KEY);
INSERT INTO @UserInRoles SELECT DISTINCT ur.[RoleID] FROM {databaseOwner}{objectQualifier}UserRoles AS ur INNER JOIN {databaseOwner}{objectQualifier}Roles AS r ON ur.RoleID = r.RoleID WHERE ur.UserID = @UserID AND r.PortalID = @PortalID AND (ur.ExpiryDate IS NULL OR ur.ExpiryDate > GETUTCDATE()) AND (ur.EffectiveDate IS NULL OR ur.EffectiveDate < GETUTCDATE());
DECLARE @UserViewCategories table (CategoryID int NOT NULL PRIMARY KEY); -- all categories which user can see based on permissions
DECLARE @UserEditCategories TABLE (CategoryID INT NOT NULL PRIMARY KEY); -- all categories which user can edit based on permissions
DECLARE @UserViewCategoriesWithFilter table (CategoryID int NOT NULL PRIMARY KEY); -- all categories which user can see based on permissions and Module filter

DECLARE @SettingsSource bit; SET @SettingsSource = 1;
IF @AdminOrSuperUser = 1 OR @PermissionSettingsSource = 0
BEGIN
	INSERT INTO @UserViewCategories SELECT [CategoryID] FROM [dbo].[EasyDNNNewsCategoryList] WHERE PortalID = @PortalID;
END
ELSE IF @UserID = -1
BEGIN	
	IF @PermissionSettingsSource = 1 -- by portal
	BEGIN
		IF EXISTS (SELECT ShowAllCategories FROM [dbo].[EasyDNNNewsRolePremissionSettings] as rps WHERE rps.PortalID = @PortalID  AND rps.ModuleID IS NULL AND rps.RoleID IS NULL AND rps.ShowAllCategories = 1)
		BEGIN
			INSERT INTO @UserViewCategories SELECT [CategoryID] FROM [dbo].[EasyDNNNewsCategoryList] WHERE PortalID = @PortalID;
		END
		ELSE
		BEGIN
			INSERT INTO @UserViewCategories
			SELECT rpsc.[CategoryID] FROM  [dbo].[EasyDNNNewsRolePremissionsShowCategories] as rpsc 
			INNER JOIN [dbo].[EasyDNNNewsRolePremissionSettings] as rps ON rps.PremissionSettingsID = rpsc.PremissionSettingsID
			WHERE rps.PortalID = @PortalID  AND rps.ModuleID IS NULL AND rps.RoleID IS NULL;
		END
	END
	ELSE -- by module
	BEGIN
		SELECT @SettingsSource = PermissionsPMSource FROM [dbo].[EasyDNNNewsModuleSettings] WHERE ModuleID = @PermissionsModuleID;
		IF @SettingsSource = 1
		BEGIN
			IF EXISTS (SELECT ShowAllCategories FROM [dbo].[EasyDNNNewsRolePremissionSettings] as rps WHERE rps.PortalID = @PortalID  AND rps.ModuleID IS NULL AND rps.RoleID IS NULL AND rps.ShowAllCategories = 1)
			BEGIN
				INSERT INTO @UserViewCategories SELECT [CategoryID] FROM [dbo].[EasyDNNNewsCategoryList] WHERE PortalID = @PortalID;
			END
			ELSE
			BEGIN
				INSERT INTO @UserViewCategories
				SELECT rpsc.[CategoryID] FROM  [dbo].[EasyDNNNewsRolePremissionsShowCategories] as rpsc 
				INNER JOIN [dbo].[EasyDNNNewsRolePremissionSettings] as rps ON rps.PremissionSettingsID = rpsc.PremissionSettingsID
				WHERE rps.PortalID = @PortalID  AND rps.ModuleID IS NULL AND rps.RoleID IS NULL;
			END
		END
		ELSE
		BEGIN
			IF EXISTS (SELECT ShowAllCategories FROM [dbo].[EasyDNNNewsRolePremissionSettings] as rps WHERE rps.PortalID = @PortalID AND rps.ModuleID = @PermissionsModuleID AND rps.RoleID IS NULL AND rps.ShowAllCategories = 1)
			BEGIN
				INSERT INTO @UserViewCategories SELECT [CategoryID] FROM [dbo].[EasyDNNNewsCategoryList] WHERE PortalID = @PortalID;
			END
			ELSE
			BEGIN
				INSERT INTO @UserViewCategories
				SELECT rpsc.[CategoryID] FROM [dbo].[EasyDNNNewsRolePremissionsShowCategories] as rpsc
				INNER JOIN [dbo].[EasyDNNNewsRolePremissionSettings] as rps ON rps.PremissionSettingsID = rpsc.PremissionSettingsID
				WHERE rps.PortalID = @PortalID AND rps.ModuleID = @PermissionsModuleID AND rps.RoleID IS NULL;
			END
		END
	END
END
ELSE -- registrirani korisnik
BEGIN
	IF @PermissionSettingsSource = 1 -- by portal
	BEGIN
		IF EXISTS (
				SELECT TOP (1) ShowAllCategories FROM [dbo].[EasyDNNNewsRolePremissionSettings] as rps
					INNER JOIN @UserInRoles as uir ON rps.RoleID = uir.RoleID
					WHERE rps.PortalID = @PortalID AND rps.ModuleID IS NULL AND rps.ShowAllCategories = 1
				UNION
				SELECT ShowAllCategories FROM [dbo].[EasyDNNNewsUserPremissionSettings] as ups
				WHERE ups.UserID = @UserID AND ups.PortalID = @PortalID AND ups.ModuleID IS NULL AND ups.ShowAllCategories = 1
		)
		BEGIN
			INSERT INTO @UserViewCategories SELECT [CategoryID] FROM [dbo].[EasyDNNNewsCategoryList] WHERE PortalID = @PortalID;
		END
		ELSE
		BEGIN
			INSERT INTO @UserViewCategories
			SELECT rpsc.[CategoryID] FROM [dbo].[EasyDNNNewsRolePremissionsShowCategories] as rpsc
			INNER JOIN [dbo].[EasyDNNNewsRolePremissionSettings] as rps ON rps.PremissionSettingsID = rpsc.PremissionSettingsID
			INNER JOIN @UserInRoles as uir ON rps.RoleID = uir.RoleID
			WHERE rps.PortalID = @PortalID AND rps.ModuleID IS NULL GROUP BY rpsc.[CategoryID]
			UNION
			SELECT upsc.[CategoryID] FROM [dbo].[EasyDNNNewsUserPremissionsShowCategories] as upsc
			INNER JOIN [dbo].[EasyDNNNewsUserPremissionSettings] as ups ON ups.PremissionSettingsID = upsc.PremissionSettingsID
			WHERE ups.UserID = @UserID AND ups.PortalID = @PortalID AND ups.ModuleID IS NULL GROUP BY upsc.[CategoryID];
		END
	END
	ELSE -- by module
	BEGIN
		SELECT @SettingsSource = PermissionsPMSource FROM [dbo].[EasyDNNNewsModuleSettings] WHERE ModuleID = @PermissionsModuleID;
		IF @SettingsSource = 1
		BEGIN
			IF EXISTS (
				SELECT TOP (1) ShowAllCategories FROM [dbo].[EasyDNNNewsRolePremissionSettings] as rps
					INNER JOIN @UserInRoles as uir ON rps.RoleID = uir.RoleID
					WHERE rps.PortalID = @PortalID AND rps.ModuleID IS NULL AND rps.ShowAllCategories = 1
				UNION
				SELECT ShowAllCategories FROM [dbo].[EasyDNNNewsUserPremissionSettings] as ups
				WHERE ups.UserID = @UserID AND ups.PortalID = @PortalID AND ups.ModuleID IS NULL AND ups.ShowAllCategories = 1
			)
			BEGIN
				INSERT INTO @UserViewCategories SELECT [CategoryID] FROM [dbo].[EasyDNNNewsCategoryList] WHERE PortalID = @PortalID;
			END
			ELSE
			BEGIN
				INSERT INTO @UserViewCategories
				SELECT rpsc.[CategoryID] FROM [dbo].[EasyDNNNewsRolePremissionsShowCategories] as rpsc
				INNER JOIN [dbo].[EasyDNNNewsRolePremissionSettings] as rps ON rps.PremissionSettingsID = rpsc.PremissionSettingsID
				INNER JOIN @UserInRoles as uir ON rps.RoleID = uir.RoleID
				WHERE rps.PortalID = @PortalID AND rps.ModuleID IS NULL GROUP BY rpsc.[CategoryID]
				UNION
				SELECT upsc.[CategoryID] FROM [dbo].[EasyDNNNewsUserPremissionsShowCategories] as upsc
				INNER JOIN [dbo].[EasyDNNNewsUserPremissionSettings] as ups ON ups.PremissionSettingsID = upsc.PremissionSettingsID
				WHERE ups.UserID = @UserID AND ups.PortalID = @PortalID AND ups.ModuleID IS NULL GROUP BY upsc.[CategoryID];
			END
		END
		ELSE
		BEGIN
			IF EXISTS (
				SELECT TOP (1) ShowAllCategories FROM [dbo].[EasyDNNNewsRolePremissionSettings] as rps
					INNER JOIN @UserInRoles as uir ON rps.RoleID = uir.RoleID
					WHERE rps.PortalID = @PortalID AND rps.ModuleID = @PermissionsModuleID AND rps.ShowAllCategories = 1
				UNION
				SELECT ShowAllCategories FROM [dbo].[EasyDNNNewsUserPremissionSettings] as ups
				WHERE ups.UserID = @UserID AND ups.PortalID = @PortalID AND ups.ModuleID = @PermissionsModuleID AND ups.ShowAllCategories = 1
			)
			BEGIN
				INSERT INTO @UserViewCategories SELECT [CategoryID] FROM [dbo].[EasyDNNNewsCategoryList] WHERE PortalID = @PortalID;
			END
			ELSE
			BEGIN
				INSERT INTO @UserViewCategories
				SELECT rpsc.[CategoryID] FROM [dbo].[EasyDNNNewsRolePremissionsShowCategories] as rpsc
				INNER JOIN [dbo].[EasyDNNNewsRolePremissionSettings] as rps ON rps.PremissionSettingsID = rpsc.PremissionSettingsID
				INNER JOIN @UserInRoles as uir ON rps.RoleID = uir.RoleID
				WHERE rps.PortalID = @PortalID AND rps.ModuleID = @PermissionsModuleID GROUP BY rpsc.[CategoryID]
				UNION
				SELECT upsc.[CategoryID] FROM [dbo].[EasyDNNNewsUserPremissionsShowCategories] as upsc
				INNER JOIN [dbo].[EasyDNNNewsUserPremissionSettings] as ups ON ups.PremissionSettingsID = upsc.PremissionSettingsID
				WHERE ups.UserID = @UserID AND ups.PortalID = @PortalID AND ups.ModuleID = @PermissionsModuleID GROUP BY upsc.[CategoryID];
			END
		END
	END
END

IF @CategoryFilterType = 0 -- 0 All categories
BEGIN
	INSERT INTO @UserViewCategoriesWithFilter SELECT [CategoryID] FROM @UserViewCategories;
END
ELSE IF @CategoryFilterType = 1 -- 1 - Selection
BEGIN
		INSERT INTO @UserViewCategoriesWithFilter 
		SELECT cl.[CategoryID] FROM @UserViewCategories as cl
		INNER JOIN [dbo].[EasyDNNNewsModuleCategoryItems] AS mci ON mci.CategoryID = cl.CategoryID AND mci.ModuleID = @MenuModuleID
END
ELSE IF @CategoryFilterType = 2 -- 2 - AutoAdd
BEGIN
	WITH hierarchy AS(
		SELECT [CategoryID], [ParentCategory]
		FROM EasyDNNNewsCategoryList AS cl
		WHERE (cl.ParentCategory IN (SELECT [CategoryID] FROM [dbo].[EasyDNNNewsModuleCategoryItems] WHERE ModuleID = @MenuModuleID) OR cl.CategoryID IN (SELECT [CategoryID] FROM [dbo].[EasyDNNNewsModuleCategoryItems] WHERE ModuleID = @MenuModuleID)) AND PortalID = @PortalID
		UNION ALL
		SELECT c.[CategoryID], c.[ParentCategory]
		FROM [dbo].[EasyDNNNewsCategoryList] AS c INNER JOIN hierarchy AS p ON c.ParentCategory = p.CategoryID WHERE c.PortalID = @PortalID
		)
	INSERT INTO @UserViewCategoriesWithFilter SELECT DISTINCT uvc.CategoryID FROM hierarchy as nfc INNER JOIN @UserViewCategories as uvc ON uvc.CategoryID = nfc.CategoryID;
END
IF @AdminOrSuperUser = 1 OR @Perm_EditAllCategores = 1
BEGIN	
	INSERT INTO @UserEditCategories SELECT CategoryID FROM [dbo].[EasyDNNNewsCategoryList] WHERE PortalID = @PortalID;
	SET @EditPermission = 1;
END
ELSE
BEGIN
	IF @UserID = -1
	BEGIN
		IF @PermissionSettingsSource = 1 -- by portal
		BEGIN
			INSERT INTO @UserEditCategories
			SELECT rpatc.[CategoryID] FROM [dbo].[EasyDNNNewsRolePremissionsAddToCategories] as rpatc
			INNER JOIN [dbo].[EasyDNNNewsRolePremissionSettings] as rps ON rps.PremissionSettingsID = rpatc.PremissionSettingsID
			WHERE rps.PortalID = @PortalID AND rps.ModuleID IS NULL AND rps.RoleID IS NULL;
		END
		ELSE -- by module
		BEGIN
		INSERT INTO @UserEditCategories
			SELECT rpatc.[CategoryID] FROM [dbo].[EasyDNNNewsRolePremissionsAddToCategories] as rpatc
			INNER JOIN [dbo].[EasyDNNNewsRolePremissionSettings] as rps ON rps.PremissionSettingsID = rpatc.PremissionSettingsID
			WHERE rps.RoleID IS NULL AND rps.PortalID = @PortalID AND rps.ModuleID = @ModuleID;
		END
	END
	ELSE -- registrirani korisnik
	BEGIN
		IF @PermissionSettingsSource = 1 -- by portal
		BEGIN
			INSERT INTO @UserEditCategories
			SELECT rpatc.[CategoryID] FROM [dbo].[EasyDNNNewsRolePremissionsAddToCategories] as rpatc
			INNER JOIN [dbo].[EasyDNNNewsRolePremissionSettings] as rps ON rps.PremissionSettingsID = rpatc.PremissionSettingsID
			INNER JOIN @UserInRoles as uir ON rps.RoleID = uir.RoleID
			WHERE rps.PortalID = @PortalID AND rps.ModuleID IS NULL GROUP BY rpatc.[CategoryID]
			UNION
			SELECT upatc.[CategoryID] FROM [dbo].[EasyDNNNewsUserPremissionsAddToCategories] as upatc
			INNER JOIN [dbo].[EasyDNNNewsUserPremissionSettings] as ups ON ups.PremissionSettingsID = upatc.PremissionSettingsID
			WHERE ups.UserID = @UserID AND ups.PortalID = @PortalID AND ups.ModuleID IS NULL GROUP BY upatc.[CategoryID];
		END
		ELSE -- by module
		BEGIN
			INSERT INTO @UserEditCategories
			SELECT rpatc.[CategoryID] FROM [dbo].[EasyDNNNewsRolePremissionsAddToCategories] as rpatc
			INNER JOIN [dbo].[EasyDNNNewsRolePremissionSettings] as rps ON rps.PremissionSettingsID = rpatc.PremissionSettingsID
			INNER JOIN @UserInRoles as uir ON rps.RoleID = uir.RoleID
			WHERE rps.PortalID = @PortalID AND rps.ModuleID = @ModuleID GROUP BY rpatc.[CategoryID]
			UNION
			SELECT upatc.[CategoryID] FROM [dbo].[EasyDNNNewsUserPremissionsAddToCategories] as upatc
			INNER JOIN [dbo].[EasyDNNNewsUserPremissionSettings] as ups ON ups.PremissionSettingsID = upatc.PremissionSettingsID
			WHERE ups.UserID = @UserID AND ups.PortalID = @PortalID AND ups.ModuleID = @ModuleID GROUP BY upatc.[CategoryID];
		END	
	END
	IF EXISTS(SELECT * FROM @UserEditCategories) BEGIN SET @EditPermission = 2; END
END
DECLARE @FilterBySocialGroup bit;
SET @FilterBySocialGroup = 0;
DECLARE @FilterAuthorOrAuthors bit;
SET @FilterAuthorOrAuthors = 0;

DECLARE @TempAuthorsIDList table (UserID int NOT NULL PRIMARY KEY);
IF @IsSocialInstance = 1
	BEGIN
		IF @FilterByDNNGroupID <> 0
		BEGIN	
			SET @FilterBySocialGroup = 1;
		END
	END
ELSE
BEGIN
	IF @ShowAllAuthors = 0
	BEGIN
		SET @FilterAuthorOrAuthors = 1;
		INSERT INTO @TempAuthorsIDList
		SELECT [UserID] FROM [dbo].[EasyDNNNewsModuleAuthorsItems] AS mai WHERE mai.ModuleID = @MenuModuleID
		UNION 
		SELECT [UserID] FROM [dbo].[EasyDNNNewsAuthorProfile] AS ap 
			INNER JOIN [dbo].[EasyDNNNewsAutorGroupItems] AS agi ON ap.AuthorProfileID = agi.AuthorProfileID
			INNER JOIN [dbo].[EasyDNNNewsModuleGroupItems] AS mgi ON mgi.GroupID = agi.GroupID
			WHERE mgi.ModuleID = @MenuModuleID
	END
END

DECLARE @tempMenuCats TABLE(
	[CategoryID] int,
	[PortalID] int,
	[CategoryName] nvarchar(200),
	[Position] int,
	[ParentCategory] int,
	[Level] int,
	[CategoryURL] nvarchar(1500),
	[CategoryImage] nvarchar(1500),
	[CategoryText] ntext,[Show] bit)

IF @LocaleCode <> ''''
BEGIN
	WITH LocCategories([CategoryID],[PortalID],[CategoryName],[Position],[ParentCategory],[Level],[CategoryURL],[CategoryImage],[CategoryText]) AS 
	(
		SELECT Cat.[CategoryID],Cat.[PortalID],cl.[Title] AS CategoryName,Cat.[Position],Cat.[ParentCategory],Cat.[Level],Cat.[CategoryURL],Cat.[CategoryImage],cl.[CategoryText] FROM EasyDNNNewsCategoryList AS Cat INNER JOIN @UserViewCategoriesWithFilter cwf ON cwf.CategoryID = Cat.CategoryID INNER JOIN EasyDNNNewsCategoryLocalization AS cl ON cwf.CategoryID = cl.CategoryID WHERE Cat.PortalID = @PortalID AND cl.LocaleCode = @LocaleCode
	),
	NotLocCategories([CategoryID],[PortalID],[CategoryName],[Position],[ParentCategory],[Level],[CategoryURL],[CategoryImage],[CategoryText]) AS 
	(
		SELECT Cat.* FROM EasyDNNNewsCategoryList AS Cat INNER JOIN @UserViewCategoriesWithFilter cwf ON cwf.CategoryID = Cat.CategoryID WHERE Cat.PortalID = @PortalID AND Cat.CategoryID NOT IN (SELECT lctemp.CategoryID FROM LocCategories as lctemp)
	)
	INSERT INTO @tempMenuCats SELECT [CategoryID],[PortalID],[CategoryName],[Position],[ParentCategory],[Level],[CategoryURL],[CategoryImage],[CategoryText],''1'' AS Show FROM (SELECT * FROM LocCategories UNION ALL SELECT * FROM NotLocCategories) as result
END
ELSE
BEGIN
	
INSERT @tempMenuCats SELECT
 [CategoryID],[PortalID],[CategoryName],[Position],[ParentCategory],[Level],[CategoryURL],[CategoryImage],[CategoryText],''1'' AS Show
 FROM [dbo].[EasyDNNNewsCategoryList] AS cat WHERE cat.CategoryID in (SELECT CategoryID FROM @UserViewCategoriesWithFilter) AND PortalID = @PortalID;

END

--INSERT @tempMenuCats SELECT
-- [CategoryID],[PortalID],[CategoryName],[Position],[ParentCategory],[Level],[CategoryURL],[CategoryImage],[CategoryText],''0'' AS Show
--  FROM [dbo].[EasyDNNNewsCategoryList] WHERE PortalID = @PortalID AND CategoryID not in (SELECT CategoryID FROM @UserViewCategoriesWithFilter);
  
SELECT TOP 1 @DefaultTabID = TabID FROM {databaseOwner}{objectQualifier}TabModules WHERE ModuleID = @DefaultModuleID;
DECLARE @TempCategoryIDAndCount table (CategoryID int NOT NULL PRIMARY KEY, Position int, ParentCategory int, Count int not null, NewsModuleID int ,TabID int);


IF @HideUnlocalizedItems = 0

BEGIN
IF @IsSocialInstance = 0
BEGIN
INSERT INTO @TempCategoryIDAndCount
SELECT CategoryID, Position, ParentCategory,
	CASE Show
	 WHEN 0 THEN 0
	 WHEN 1 THEN	
		CASE @AdminOrSuperUser
		WHEN 1 THEN
		(
		 SELECT count(n.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n
			 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON n.ArticleID = c.ArticleID AND c.CategoryID = Result.CategoryID
			 WHERE n.PublishDate <= @CurrentDate
			 AND n.ExpireDate >= @CurrentDate
			 AND n.PortalID = @PortalID
			 AND((@FilterAuthorOrAuthors = 1 AND n.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))			 
		)
		WHEN 0 THEN
		(
		SELECT (
					(
						SELECT count(n.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON n.ArticleID = c.ArticleID AND c.CategoryID = Result.CategoryID
						 WHERE n.PublishDate <= @CurrentDate
							 AND n.ExpireDate >= @CurrentDate
							 AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							 AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							 AND n.HasPermissions = 0
							 AND n.PortalID = @PortalID
							 AND((@FilterAuthorOrAuthors = 1 AND n.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
					 )
					 +
					(
						SELECT count(aup.[ArticleID]) FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
						 WHERE ((@UserID = -1 AND aup.UserID IS NULL) OR (aup.UserID = @UserID))
					 		AND n.PublishDate <= @CurrentDate
							AND n.ExpireDate >= @CurrentDate
							AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							AND n.HasPermissions = 1
							AND n.PortalID = @PortalID
							AND((@FilterAuthorOrAuthors = 1 AND n.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
					 )	 
					+ 
					(
						CASE @UserID
						WHEN -1 THEN 0
						ELSE			
					(
						SELECT count(PerRoles.[ArticleID]) FROM 
						
						(SELECT DISTINCT arp.[ArticleID] FROM [dbo].[EasyDNNNewsArticleRolePermissions] as arp
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = arp.ArticleID AND c.CategoryID = Result.CategoryID
						 WHERE arp.RoleID IN (SELECT RoleID FROM @UserInRoles)
						  AND arp.ArticleID NOT IN (
							SELECT aup.[ArticleID] FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
							INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
							INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
								WHERE aup.UserID = @UserID
					 				AND n.PublishDate <= @CurrentDate
									AND n.ExpireDate >= @CurrentDate
									AND ((@UserCanApprove = 1) OR (n.Approved = 1))
									AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
									AND n.HasPermissions = 1
									AND n.PortalID = @PortalID
									AND((@FilterAuthorOrAuthors = 1 AND n.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
							)
						 ) as PerRoles 
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = PerRoles.ArticleID
						 WHERE n.PublishDate <= @CurrentDate
						 AND n.ExpireDate >= @CurrentDate
						 AND ((@UserCanApprove = 1) OR (n.Approved = 1))
						 AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
						 AND n.HasPermissions = 1
						 AND n.PortalID = @PortalID
						 AND((@FilterAuthorOrAuthors = 1 AND n.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
						 )
			END
					)
				)
		)
		END		
	 END AS ''Count'',NewsModuleID,TabID
	FROM 
	(SELECT 
	ncl.[CategoryID],
	ncl.[Position],
	ncl.[ParentCategory],
	ncl.Show,
		CASE WHEN cl.[NewsModuleID] IS NULL THEN @DefaultModuleID ELSE cl.[NewsModuleID] END AS NewsModuleID,
		CASE WHEN tm.[TabID] IS NULL THEN @DefaultTabID ELSE tm.[TabID] END AS TabID
	FROM @tempMenuCats as ncl LEFT OUTER JOIN [dbo].[EasyDNNNewsCategoryLink] as cl
	ON ncl.CategoryID = cl.CategoryID AND cl.[SourceModuleID] = @MenuModuleID
	LEFT OUTER JOIN {databaseOwner}{objectQualifier}TabModules AS tm ON cl.NewsModuleID = tm.ModuleID) as Result
	
	SELECT n.ArticleID,n.Title,n.TitleLink,n.PublishDate,n.NumberOfViews,n.RatingValue,n.DateAdded,n.ExpireDate,n.LastModified,
	 n.HasPermissions, n.Active, n.Approved, n.NumberOfComments,n.UserID, c.[CategoryID], ncl.[Position], ncl.Count, ncl.NewsModuleID,ncl.TabID
	 FROM [dbo].[EasyDNNNews] as n
	  INNER JOIN [dbo].[EasyDNNNewsCategories] c ON n.ArticleID = c.ArticleID 
	  INNER JOIN @TempCategoryIDAndCount as ncl ON ncl.CategoryID = c.CategoryID
	  INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = c.CategoryID AND cidl.Show = 1 WHERE n.ArticleID IN(
		Select DISTINCT na.[ArticleID] FROM [dbo].[EasyDNNNews] as na
		INNER JOIN [dbo].[EasyDNNNewsCategories] as cat ON na.ArticleID = cat.ArticleID
		INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = cat.CategoryID AND cidl.Show = 1
		   WHERE na.PortalID=@PortalID
		   AND ((@EditPermission = 1) OR (
				(@UserCanApprove = 1 OR na.Approved = 1)
				 AND (na.Active = 1 OR na.UserID=@UserID)
				 ))
		   AND na.HasPermissions = 0
		   AND na.PublishDate <= @CurrentDate
		   AND na.ExpireDate >= @CurrentDate
		   AND((@FilterAuthorOrAuthors = 1 AND na.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
		UNION ALL
		Select DISTINCT na.[ArticleID] FROM [dbo].[EasyDNNNews] as na
			 INNER JOIN [dbo].[EasyDNNNewsArticleUserPermissions] as aup ON na.ArticleID = aup.ArticleID
			 INNER JOIN [dbo].[EasyDNNNewsCategories] as cat ON na.ArticleID = cat.ArticleID
			 INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = cat.CategoryID AND cidl.Show = 1
			 WHERE na.PortalID=@PortalID
			 AND ((@EditPermission = 1) OR (
				 ((@UserID = -1 AND aup.UserID IS NULL) OR (aup.UserID = @UserID))
				 AND aup.Show = 1
				 AND ((@UserCanApprove = 1) OR (na.Approved = 1))
				 AND (na.Active = 1 OR na.UserID=@UserID)
			 ))
			 AND na.HasPermissions = 1
		     AND na.PublishDate <= @CurrentDate
		     AND na.ExpireDate >= @CurrentDate
		   	 AND((@FilterAuthorOrAuthors = 1 AND na.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
		UNION
		Select DISTINCT na.[ArticleID] FROM [dbo].[EasyDNNNews] as na
			  INNER JOIN [dbo].[EasyDNNNewsArticleRolePermissions] as arp ON na.ArticleID = arp.ArticleID
			  INNER JOIN [dbo].[EasyDNNNewsCategories] as cat ON na.ArticleID = cat.ArticleID
			  INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = cat.CategoryID AND cidl.Show = 1
			  WHERE na.PortalID=@PortalID
			  AND ((@EditPermission = 1) OR (
					((@UserCanApprove = 1) OR (na.Approved = 1))
					AND (na.Active = 1 OR na.UserID=@UserID)
					AND arp.Show = 1
					AND arp.RoleID IN (SELECT [RoleID] FROM @UserInRoles)
					))
			  AND na.HasPermissions = 1
			  AND na.PublishDate <= @CurrentDate
		      AND na.ExpireDate >= @CurrentDate
			  AND((@FilterAuthorOrAuthors = 1 AND na.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))	 
		) 
		ORDER BY ncl.Position, n.PublishDate;
	
END
ELSE IF @FilterBySocialGroup = 1
BEGIN
INSERT INTO @TempCategoryIDAndCount
SELECT CategoryID, Position, ParentCategory,
	CASE Show
	 WHEN 0 THEN 0
	 WHEN 1 THEN	
		CASE @AdminOrSuperUser
		WHEN 1 THEN
		(
		 SELECT count(n.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n
			 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON n.ArticleID = c.ArticleID AND c.CategoryID = Result.CategoryID
			 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
			 INNER JOIN [dbo].[EasyDNNNewsSocialGroupItems] AS sgi ON sgi.ArticleID = n.ArticleID AND sgi.RoleID = @FilterByDNNGroupID
			 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
			 WHERE  n.PublishDate <= @CurrentDate
				AND n.ExpireDate >= @CurrentDate
				AND n.PortalID = @PortalID
		)
		WHEN 0 THEN
		(
		SELECT (
					(
						SELECT count(n.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n
						INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON n.ArticleID = c.ArticleID AND c.CategoryID = Result.CategoryID
						INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
						INNER JOIN [dbo].[EasyDNNNewsSocialGroupItems] AS sgi ON sgi.ArticleID = n.ArticleID AND sgi.RoleID = @FilterByDNNGroupID
						INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
						 WHERE n.PublishDate <= @CurrentDate
							 AND n.ExpireDate >= @CurrentDate
							 AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							 AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							 AND n.HasPermissions = 0
							 AND n.PortalID = @PortalID
					 )
					 +
					(
						SELECT count(aup.[ArticleID]) FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
						 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
						 INNER JOIN EasyDNNNewsSocialGroupItems AS sgi ON sgi.ArticleID = n.ArticleID AND sgi.RoleID = @FilterByDNNGroupID
						 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
						 WHERE ((@UserID = -1 AND aup.UserID IS NULL) OR (aup.UserID = @UserID))
					 		AND n.PublishDate <= @CurrentDate
							AND n.ExpireDate >= @CurrentDate
							AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							AND n.HasPermissions = 1
							AND n.PortalID = @PortalID
					 )	 
					+ 
					(
						CASE @UserID
						WHEN -1 THEN 0
						ELSE			
					(
						SELECT count(PerRoles.[ArticleID]) FROM 
						
						(SELECT DISTINCT arp.[ArticleID] FROM [dbo].[EasyDNNNewsArticleRolePermissions] as arp
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = arp.ArticleID AND c.CategoryID = Result.CategoryID
						 WHERE arp.RoleID IN (SELECT RoleID FROM @UserInRoles)
						  AND arp.ArticleID NOT IN (
							SELECT aup.[ArticleID] FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
							INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
							INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
							INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
							INNER JOIN [dbo].[EasyDNNNewsSocialGroupItems] AS sgi ON sgi.ArticleID = n.ArticleID AND sgi.RoleID = @FilterByDNNGroupID
							INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
								WHERE aup.UserID = @UserID
					 				AND n.PublishDate <= @CurrentDate
									AND n.ExpireDate >= @CurrentDate
									AND ((@UserCanApprove = 1) OR (n.Approved = 1))
									AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
									AND n.HasPermissions = 1
									AND n.PortalID = @PortalID
							)
						 ) as PerRoles 
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = PerRoles.ArticleID
						 WHERE n.PublishDate <= @CurrentDate
						 AND n.ExpireDate >= @CurrentDate
						 AND ((@UserCanApprove = 1) OR (n.Approved = 1))
						 AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
						 AND n.HasPermissions = 1
						 AND n.PortalID = @PortalID
						 )
			END
					)
				)
		)
		END		
	 END AS ''Count'',NewsModuleID,TabID
	FROM 
	(SELECT 
	ncl.[CategoryID],
	ncl.[Position],
	ncl.[ParentCategory],
	ncl.Show,
		CASE WHEN cl.[NewsModuleID] IS NULL THEN @DefaultModuleID ELSE cl.[NewsModuleID] END AS NewsModuleID,
		CASE WHEN tm.[TabID] IS NULL THEN @DefaultTabID ELSE tm.[TabID] END AS TabID
	FROM @tempMenuCats as ncl LEFT OUTER JOIN [dbo].[EasyDNNNewsCategoryLink] as cl
	ON ncl.CategoryID = cl.CategoryID AND cl.[SourceModuleID] = @MenuModuleID
	LEFT OUTER JOIN {databaseOwner}{objectQualifier}TabModules AS tm ON cl.NewsModuleID = tm.ModuleID) as Result
	
	SELECT n.ArticleID,n.Title,n.TitleLink,n.PublishDate,n.NumberOfViews,n.RatingValue,n.DateAdded,n.ExpireDate,n.LastModified,
	 n.HasPermissions, n.Active, n.Approved, n.NumberOfComments,n.UserID, c.[CategoryID], ncl.[Position], ncl.Count, ncl.NewsModuleID,ncl.TabID
	 FROM [dbo].[EasyDNNNews] as n
	  INNER JOIN [dbo].[EasyDNNNewsCategories] c ON n.ArticleID = c.ArticleID 
	  INNER JOIN @TempCategoryIDAndCount as ncl ON ncl.CategoryID = c.CategoryID
	  INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = c.CategoryID AND cidl.Show = 1 WHERE n.ArticleID IN(
		Select DISTINCT na.[ArticleID] FROM [dbo].[EasyDNNNews] as na
		INNER JOIN [dbo].[EasyDNNNewsCategories] as cat ON na.ArticleID = cat.ArticleID
		INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = cat.CategoryID AND cidl.Show = 1
		INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = na.ArticleID
		INNER JOIN [dbo].[EasyDNNNewsSocialGroupItems] AS sgi ON sgi.ArticleID = na.ArticleID AND sgi.RoleID = @FilterByDNNGroupID
		INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId, @UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
		   WHERE na.PortalID=@PortalID
		   AND ((@EditPermission = 1) OR (
				(@UserCanApprove = 1 OR na.Approved = 1)
				 AND (na.Active = 1 OR na.UserID=@UserID)
				 ))
		   AND na.HasPermissions = 0
		   AND na.PublishDate <= @CurrentDate
		   AND na.ExpireDate >= @CurrentDate
		   AND((@FilterAuthorOrAuthors = 1 AND na.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
		UNION ALL
		Select DISTINCT na.[ArticleID] FROM [dbo].[EasyDNNNews] as na
			 INNER JOIN [dbo].[EasyDNNNewsArticleUserPermissions] as aup ON na.ArticleID = aup.ArticleID
			 INNER JOIN [dbo].[EasyDNNNewsCategories] as cat ON na.ArticleID = cat.ArticleID
			 INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = cat.CategoryID AND cidl.Show = 1
			 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = na.ArticleID
			 INNER JOIN [dbo].[EasyDNNNewsSocialGroupItems] AS sgi ON sgi.ArticleID = na.ArticleID AND sgi.RoleID = @FilterByDNNGroupID
			 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
			 WHERE na.PortalID=@PortalID
			 AND ((@EditPermission = 1) OR (
				 ((@UserID = -1 AND aup.UserID IS NULL) OR (aup.UserID = @UserID))
				 AND aup.Show = 1
				 AND ((@UserCanApprove = 1) OR (na.Approved = 1))
				 AND (na.Active = 1 OR na.UserID=@UserID)
			 ))
			 AND na.HasPermissions = 1
		     AND na.PublishDate <= @CurrentDate
		     AND na.ExpireDate >= @CurrentDate
		   	 AND((@FilterAuthorOrAuthors = 1 AND na.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
		UNION
		Select DISTINCT na.[ArticleID] FROM [dbo].[EasyDNNNews] as na
			  INNER JOIN [dbo].[EasyDNNNewsArticleRolePermissions] as arp ON na.ArticleID = arp.ArticleID
			  INNER JOIN [dbo].[EasyDNNNewsCategories] as cat ON na.ArticleID = cat.ArticleID
			  INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = cat.CategoryID AND cidl.Show = 1
			  INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = na.ArticleID
			  INNER JOIN [dbo].[EasyDNNNewsSocialGroupItems] AS sgi ON sgi.ArticleID = na.ArticleID AND sgi.RoleID = @FilterByDNNGroupID
			  INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
			  WHERE na.PortalID=@PortalID
			  AND ((@EditPermission = 1) OR (
					((@UserCanApprove = 1) OR (na.Approved = 1))
					AND (na.Active = 1 OR na.UserID=@UserID)
					AND arp.Show = 1
					AND arp.RoleID IN (SELECT [RoleID] FROM @UserInRoles)
					))
			  AND na.HasPermissions = 1
			  AND na.PublishDate <= @CurrentDate
		      AND na.ExpireDate >= @CurrentDate
			  AND((@FilterAuthorOrAuthors = 1 AND na.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))	 
		) 
		ORDER BY ncl.Position, n.PublishDate;
	
END
ELSE IF @FilterByDNNUserID <> 0
BEGIN
INSERT INTO @TempCategoryIDAndCount
SELECT CategoryID, Position, ParentCategory,
	CASE Show
	 WHEN 0 THEN 0
	 WHEN 1 THEN	
		CASE @AdminOrSuperUser
		WHEN 1 THEN
		(
		 SELECT count(n.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n
		 
			 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON n.ArticleID = c.ArticleID
			 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID AND c.CategoryID = Result.CategoryID
			 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
			 WHERE  n.PublishDate <= @CurrentDate
				AND n.ExpireDate >= @CurrentDate
				AND n.PortalID = @PortalID
				AND n.UserID = @FilterByDNNUserID 
		)
		WHEN 0 THEN
		(
		SELECT (
					(
						SELECT count(n.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON n.ArticleID = c.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
						 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
						 WHERE n.PublishDate <= @CurrentDate
							 AND n.ExpireDate >= @CurrentDate
							 AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							 AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							 AND n.HasPermissions = 0
							 AND n.PortalID = @PortalID
							 AND n.UserID = @FilterByDNNUserID
					)
					 +
					(
						SELECT count(aup.[ArticleID]) FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
						 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
						 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
						 WHERE ((@UserID = -1 AND aup.UserID IS NULL) OR (aup.UserID = @UserID))
					 		AND n.PublishDate <= @CurrentDate
							AND n.ExpireDate >= @CurrentDate
							AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							AND n.HasPermissions = 1
							AND n.PortalID = @PortalID
							AND n.UserID = @FilterByDNNUserID 					 )	 
					+ 
					(
						CASE @UserID
						WHEN -1 THEN 0
						ELSE			
					(
						SELECT count(PerRoles.[ArticleID]) FROM 
						
						(SELECT DISTINCT arp.[ArticleID] FROM [dbo].[EasyDNNNewsArticleRolePermissions] as arp
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = arp.ArticleID AND c.CategoryID = Result.CategoryID
						 WHERE arp.RoleID IN (SELECT RoleID FROM @UserInRoles)
						  AND arp.ArticleID NOT IN (
							SELECT aup.[ArticleID] FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
							INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
							INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
							INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
							INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
								WHERE aup.UserID = @UserID
					 				AND n.PublishDate <= @CurrentDate
									AND n.ExpireDate >= @CurrentDate
									AND ((@UserCanApprove = 1) OR (n.Approved = 1))
									AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
									AND n.HasPermissions = 1
									AND n.PortalID = @PortalID
									AND n.UserID = @FilterByDNNUserID 
			  				)
						 ) as PerRoles 
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = PerRoles.ArticleID
						 WHERE n.PublishDate <= @CurrentDate
						 AND n.ExpireDate >= @CurrentDate
						 AND ((@UserCanApprove = 1) OR (n.Approved = 1))
						 AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
						 AND n.HasPermissions = 1
						 AND n.PortalID = @PortalID
						 AND n.UserID = @FilterByDNNUserID 						 )
			END
					)
				)
		)
		END		
	 END AS ''Count'',NewsModuleID,TabID
	FROM 
	(SELECT 
	ncl.[CategoryID],
	ncl.[Position],
	ncl.[ParentCategory],
	ncl.Show,
		CASE WHEN cl.[NewsModuleID] IS NULL THEN @DefaultModuleID ELSE cl.[NewsModuleID] END AS NewsModuleID,
		CASE WHEN tm.[TabID] IS NULL THEN @DefaultTabID ELSE tm.[TabID] END AS TabID
	FROM @tempMenuCats as ncl LEFT OUTER JOIN [dbo].[EasyDNNNewsCategoryLink] as cl
	ON ncl.CategoryID = cl.CategoryID AND cl.[SourceModuleID] = @MenuModuleID
	LEFT OUTER JOIN {databaseOwner}{objectQualifier}TabModules AS tm ON cl.NewsModuleID = tm.ModuleID) as Result
	
	SELECT n.ArticleID,n.Title,n.TitleLink,n.PublishDate,n.NumberOfViews,n.RatingValue,n.DateAdded,n.ExpireDate,n.LastModified,
	 n.HasPermissions, n.Active, n.Approved, n.NumberOfComments,n.UserID, c.[CategoryID], ncl.[Position], ncl.Count, ncl.NewsModuleID,ncl.TabID
	 FROM [dbo].[EasyDNNNews] as n
	  INNER JOIN [dbo].[EasyDNNNewsCategories] c ON n.ArticleID = c.ArticleID 
	  INNER JOIN @TempCategoryIDAndCount as ncl ON ncl.CategoryID = c.CategoryID
	  INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = c.CategoryID AND cidl.Show = 1 WHERE n.ArticleID IN(
		Select DISTINCT na.[ArticleID] FROM [dbo].[EasyDNNNews] as na
		INNER JOIN [dbo].[EasyDNNNewsCategories] as cat ON na.ArticleID = cat.ArticleID
		INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = cat.CategoryID AND cidl.Show = 1
		INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = na.ArticleID
		INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
		   WHERE na.PortalID=@PortalID
		   AND ((@EditPermission = 1) OR (
				(@UserCanApprove = 1 OR na.Approved = 1)
				 AND (na.Active = 1 OR na.UserID=@UserID)
				 ))
		   AND na.HasPermissions = 0
		   AND na.PublishDate <= @CurrentDate
		   AND na.ExpireDate >= @CurrentDate
		   AND((@FilterAuthorOrAuthors = 1 AND na.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
		UNION ALL
		Select DISTINCT na.[ArticleID] FROM [dbo].[EasyDNNNews] as na
			 INNER JOIN [dbo].[EasyDNNNewsArticleUserPermissions] as aup ON na.ArticleID = aup.ArticleID
			 INNER JOIN [dbo].[EasyDNNNewsCategories] as cat ON na.ArticleID = cat.ArticleID
			 INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = cat.CategoryID AND cidl.Show = 1
			 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = na.ArticleID
			 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
			 WHERE na.PortalID=@PortalID
			 AND ((@EditPermission = 1) OR (
				 ((@UserID = -1 AND aup.UserID IS NULL) OR (aup.UserID = @UserID))
				 AND aup.Show = 1
				 AND ((@UserCanApprove = 1) OR (na.Approved = 1))
				 AND (na.Active = 1 OR na.UserID=@UserID)
			 ))
			 AND na.HasPermissions = 1
		     AND na.PublishDate <= @CurrentDate
		     AND na.ExpireDate >= @CurrentDate
		   	 AND((@FilterAuthorOrAuthors = 1 AND na.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
		UNION
		Select DISTINCT na.[ArticleID] FROM [dbo].[EasyDNNNews] as na
			  INNER JOIN [dbo].[EasyDNNNewsArticleRolePermissions] as arp ON na.ArticleID = arp.ArticleID
			  INNER JOIN [dbo].[EasyDNNNewsCategories] as cat ON na.ArticleID = cat.ArticleID
			  INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = cat.CategoryID AND cidl.Show = 1
			  INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = na.ArticleID
			  INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
			  WHERE na.PortalID=@PortalID
			  AND ((@EditPermission = 1) OR (
					((@UserCanApprove = 1) OR (na.Approved = 1))
					AND (na.Active = 1 OR na.UserID=@UserID)
					AND arp.Show = 1
					AND arp.RoleID IN (SELECT [RoleID] FROM @UserInRoles)
					))
			  AND na.HasPermissions = 1
			  AND na.PublishDate <= @CurrentDate
		      AND na.ExpireDate >= @CurrentDate
			  AND((@FilterAuthorOrAuthors = 1 AND na.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))	 
		) 
		ORDER BY ncl.Position, n.PublishDate;
	
END
END

ELSE

BEGIN
IF @IsSocialInstance = 0
BEGIN
INSERT INTO @TempCategoryIDAndCount
SELECT CategoryID, Position, ParentCategory,
	CASE Show
	 WHEN 0 THEN 0
	 WHEN 1 THEN	
		CASE @AdminOrSuperUser
		WHEN 1 THEN
		(
		 SELECT count(c.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n
			 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON n.ArticleID = c.ArticleID AND c.CategoryID = Result.CategoryID
			 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
			 WHERE n.PublishDate <= @CurrentDate
				AND n.ExpireDate >= @CurrentDate
				AND n.PortalID = @PortalID
				AND((@FilterAuthorOrAuthors = 1 AND n.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))		 
		)
		WHEN 0 THEN
		(
		SELECT (
					(
						SELECT count(n.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON n.ArticleID = c.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
						 WHERE n.PublishDate <= @CurrentDate
							 AND n.ExpireDate >= @CurrentDate
							 AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							 AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							 AND n.HasPermissions = 0
							 AND n.PortalID = @PortalID
							 AND((@FilterAuthorOrAuthors = 1 AND n.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
					 )
					 +
					(
						SELECT count(aup.[ArticleID]) FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
						 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
						 WHERE ((@UserID = -1 AND aup.UserID IS NULL) OR (aup.UserID = @UserID))
					 		AND n.PublishDate <= @CurrentDate
							AND n.ExpireDate >= @CurrentDate
							AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							AND n.HasPermissions = 1
							AND n.PortalID = @PortalID
							AND((@FilterAuthorOrAuthors = 1 AND n.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
					 )	 
					+ 
					(
						CASE @UserID
						WHEN -1 THEN 0
						ELSE			
					(
						SELECT count(PerRoles.[ArticleID]) FROM 
						
						(SELECT DISTINCT arp.[ArticleID] FROM [dbo].[EasyDNNNewsArticleRolePermissions] as arp
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = arp.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = arp.ArticleID AND ncl.LocaleCode = @LocaleCode
						 WHERE arp.RoleID IN (SELECT RoleID FROM @UserInRoles)
						  AND arp.ArticleID NOT IN (
							SELECT aup.[ArticleID] FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
							INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
							INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
							INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
								WHERE aup.UserID = @UserID
					 				AND n.PublishDate <= @CurrentDate
									AND n.ExpireDate >= @CurrentDate
									AND ((@UserCanApprove = 1) OR (n.Approved = 1))
									AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
									AND n.HasPermissions = 1
									AND n.PortalID = @PortalID
									AND((@FilterAuthorOrAuthors = 1 AND n.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
							)
						 ) as PerRoles 
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = PerRoles.ArticleID
						 WHERE n.PublishDate <= @CurrentDate
							AND n.ExpireDate >= @CurrentDate
							AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							AND n.HasPermissions = 1
							AND n.PortalID = @PortalID
							AND((@FilterAuthorOrAuthors = 1 AND n.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
						 )
			END
					)
				)
		)
		END		
	 END AS ''Count'',NewsModuleID,TabID
	FROM 
	(SELECT 
	ncl.[CategoryID],
	ncl.[Position],
	ncl.[ParentCategory],
	ncl.Show,
		CASE WHEN cl.[NewsModuleID] IS NULL THEN @DefaultModuleID ELSE cl.[NewsModuleID] END AS NewsModuleID,
		CASE WHEN tm.[TabID] IS NULL THEN @DefaultTabID ELSE tm.[TabID] END AS TabID
	FROM @tempMenuCats as ncl LEFT OUTER JOIN [dbo].[EasyDNNNewsCategoryLink] as cl
	ON ncl.CategoryID = cl.CategoryID AND cl.[SourceModuleID] = @MenuModuleID
	LEFT OUTER JOIN {databaseOwner}{objectQualifier}TabModules AS tm ON cl.NewsModuleID = tm.ModuleID) as Result

	SELECT n.ArticleID,n.Title,n.TitleLink,n.PublishDate,n.NumberOfViews,n.RatingValue,n.DateAdded,n.ExpireDate,n.LastModified,
	 n.HasPermissions, n.Active, n.Approved, n.NumberOfComments,n.UserID, c.[CategoryID], tempc.[Position], tempc.Count, tempc.NewsModuleID,tempc.TabID
	 FROM [dbo].[EasyDNNNews] as n
	  INNER JOIN  [dbo].[EasyDNNNewsCategories]  c ON n.ArticleID = c.ArticleID 
	  INNER JOIN @TempCategoryIDAndCount as tempc ON tempc.CategoryID = c.CategoryID
	  INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = c.CategoryID AND cidl.Show = 1
	   WHERE n.ArticleID IN(
		Select DISTINCT na.[ArticleID] FROM [dbo].[EasyDNNNews] as na
		INNER JOIN  [dbo].[EasyDNNNewsCategories]  as cat ON na.ArticleID = cat.ArticleID
		INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = cat.CategoryID AND cidl.Show = 1
		INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = na.ArticleID AND ncl.LocaleCode = @LocaleCode
		   WHERE na.PortalID=@PortalID
		   AND ((@EditPermission = 1) OR (
				(@UserCanApprove = 1 OR na.Approved = 1)
				 AND (na.Active = 1 OR na.UserID=@UserID)
				 ))
		   AND na.HasPermissions = 0
		   AND na.PublishDate <= @CurrentDate
		   AND na.ExpireDate >= @CurrentDate
		   AND((@FilterAuthorOrAuthors = 1 AND na.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
		UNION ALL
		Select DISTINCT na.[ArticleID] FROM [dbo].[EasyDNNNews] as na
			 INNER JOIN [dbo].[EasyDNNNewsArticleUserPermissions] as aup ON na.ArticleID = aup.ArticleID
			 INNER JOIN [dbo].[EasyDNNNewsCategories] as cat ON na.ArticleID = cat.ArticleID
			 INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = cat.CategoryID AND cidl.Show = 1
			 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = na.ArticleID AND ncl.LocaleCode = @LocaleCode
			 WHERE na.PortalID=@PortalID
			 AND ((@EditPermission = 1) OR (
				 ((@UserID = -1 AND aup.UserID IS NULL) OR (aup.UserID = @UserID))
				 AND aup.Show = 1
				 AND ((@UserCanApprove = 1) OR (na.Approved = 1))
				 AND (na.Active = 1 OR na.UserID=@UserID)
			 ))
			 AND na.HasPermissions = 1
		     AND na.PublishDate <= @CurrentDate
		     AND na.ExpireDate >= @CurrentDate
		   	 AND((@FilterAuthorOrAuthors = 1 AND na.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
		UNION
		Select DISTINCT na.[ArticleID] FROM [dbo].[EasyDNNNews] as na
			  INNER JOIN [dbo].[EasyDNNNewsArticleRolePermissions] as arp ON na.ArticleID = arp.ArticleID
			  INNER JOIN [dbo].[EasyDNNNewsCategories] as cat ON na.ArticleID = cat.ArticleID
			  INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = cat.CategoryID AND cidl.Show = 1
			  INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = na.ArticleID AND ncl.LocaleCode = @LocaleCode
			  WHERE na.PortalID=@PortalID
			  AND ((@EditPermission = 1) OR (
					((@UserCanApprove = 1) OR (na.Approved = 1))
					AND (na.Active = 1 OR na.UserID=@UserID)
					AND arp.Show = 1
					AND arp.RoleID IN (SELECT [RoleID] FROM @UserInRoles)
					))
			  AND na.HasPermissions = 1
			  AND na.PublishDate <= @CurrentDate
		      AND na.ExpireDate >= @CurrentDate
			  AND((@FilterAuthorOrAuthors = 1 AND na.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))	 
		) 
		ORDER BY tempc.Position, n.PublishDate;
	
END
ELSE IF @FilterBySocialGroup = 1
BEGIN
INSERT INTO @TempCategoryIDAndCount
SELECT CategoryID, Position, ParentCategory,
	CASE Show
	 WHEN 0 THEN 0
	 WHEN 1 THEN	
		CASE @AdminOrSuperUser
		WHEN 1 THEN
		(
		 SELECT count(n.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n
			 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON n.ArticleID = c.ArticleID AND c.CategoryID = Result.CategoryID
			 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
			 INNER JOIN [dbo].[EasyDNNNewsSocialGroupItems] AS sgi ON sgi.ArticleID = n.ArticleID AND sgi.RoleID = @FilterByDNNGroupID
			 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
			 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
			 WHERE n.PublishDate <= @CurrentDate
				AND n.ExpireDate >= @CurrentDate
				AND n.PortalID = @PortalID
		)
		WHEN 0 THEN
		(
		SELECT (
					(
						SELECT count(n.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n
						INNER JOIN [dbo].[EasyDNNNewsCategories]  AS c ON n.ArticleID = c.ArticleID AND c.CategoryID = Result.CategoryID
						INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
						INNER JOIN [dbo].[EasyDNNNewsSocialGroupItems] AS sgi ON sgi.ArticleID = n.ArticleID AND sgi.RoleID = @FilterByDNNGroupID
						INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
						INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
						 WHERE n.PublishDate <= @CurrentDate
							 AND n.ExpireDate >= @CurrentDate
							 AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							 AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							 AND n.HasPermissions = 0
							 AND n.PortalID = @PortalID
					 )
					 +
					(
						SELECT count(aup.[ArticleID]) FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
						 INNER JOIN [dbo].[EasyDNNNewsCategories]  AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
						 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
						 INNER JOIN [dbo].[EasyDNNNewsSocialGroupItems] AS sgi ON sgi.ArticleID = n.ArticleID AND sgi.RoleID = @FilterByDNNGroupID
						 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
						 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
						 WHERE ((@UserID = -1 AND aup.UserID IS NULL) OR (aup.UserID = @UserID))
					 		AND n.PublishDate <= @CurrentDate
							AND n.ExpireDate >= @CurrentDate
							AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							AND n.HasPermissions = 1
							AND n.PortalID = @PortalID
					 )	 
					+ 
					(
						CASE @UserID
						WHEN -1 THEN 0
						ELSE			
					(
						SELECT count(PerRoles.[ArticleID]) FROM 
						
						(SELECT DISTINCT arp.[ArticleID] FROM [dbo].[EasyDNNNewsArticleRolePermissions] as arp
						 INNER JOIN [dbo].[EasyDNNNewsCategories]  AS c ON c.ArticleID = arp.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = arp.ArticleID AND ncl.LocaleCode = @LocaleCode
						 WHERE arp.RoleID IN (SELECT RoleID FROM @UserInRoles)
						  AND arp.ArticleID NOT IN (
							SELECT aup.[ArticleID] FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
							INNER JOIN [dbo].[EasyDNNNewsCategories]  AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
							INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
							INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
							INNER JOIN [dbo].[EasyDNNNewsSocialGroupItems] AS sgi ON sgi.ArticleID = n.ArticleID AND sgi.RoleID = @FilterByDNNGroupID
							INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
							INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
								WHERE aup.UserID = @UserID
					 				AND n.PublishDate <= @CurrentDate
									AND n.ExpireDate >= @CurrentDate
									AND ((@UserCanApprove = 1) OR (n.Approved = 1))
									AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
									AND n.HasPermissions = 1
									AND n.PortalID = @PortalID
							)
						 ) as PerRoles 
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = PerRoles.ArticleID
						 WHERE n.PublishDate <= @CurrentDate
						 AND n.ExpireDate >= @CurrentDate
						 AND ((@UserCanApprove = 1) OR (n.Approved = 1))
						 AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
						 AND n.HasPermissions = 1
						 AND n.PortalID = @PortalID
						 )
			END
					)
				)
		)
		END		
	 END AS ''Count'',NewsModuleID,TabID
	FROM 
	(SELECT 
	ncl.[CategoryID],
	ncl.[Position],
	ncl.[ParentCategory],
	ncl.Show,
		CASE WHEN cl.[NewsModuleID] IS NULL THEN @DefaultModuleID ELSE cl.[NewsModuleID] END AS NewsModuleID,
		CASE WHEN tm.[TabID] IS NULL THEN @DefaultTabID ELSE tm.[TabID] END AS TabID
	FROM @tempMenuCats as ncl LEFT OUTER JOIN [dbo].[EasyDNNNewsCategoryLink] as cl
	ON ncl.CategoryID = cl.CategoryID AND cl.[SourceModuleID] = @MenuModuleID
	LEFT OUTER JOIN {databaseOwner}{objectQualifier}TabModules AS tm ON cl.NewsModuleID = tm.ModuleID) as Result

	SELECT n.ArticleID,n.Title,n.TitleLink,n.PublishDate,n.NumberOfViews,n.RatingValue,n.DateAdded,n.ExpireDate,n.LastModified,
	 n.HasPermissions, n.Active, n.Approved, n.NumberOfComments,n.UserID, c.[CategoryID], tempc.[Position], tempc.Count, tempc.NewsModuleID,tempc.TabID
	 FROM [dbo].[EasyDNNNews] as n
	  INNER JOIN [dbo].[EasyDNNNewsCategories] c ON n.ArticleID = c.ArticleID 
	  INNER JOIN @TempCategoryIDAndCount as tempc ON tempc.CategoryID = c.CategoryID
	  INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = c.CategoryID AND cidl.Show = 1
		WHERE n.ArticleID IN(
		Select DISTINCT na.[ArticleID] FROM [dbo].[EasyDNNNews] as na
		INNER JOIN [dbo].[EasyDNNNewsCategories] as cat ON na.ArticleID = cat.ArticleID
		INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = cat.CategoryID AND cidl.Show = 1
		INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = na.ArticleID
		INNER JOIN [dbo].[EasyDNNNewsSocialGroupItems] AS sgi ON sgi.ArticleID = na.ArticleID AND sgi.RoleID = @FilterByDNNGroupID
		INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId, @UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
		INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = na.ArticleID AND ncl.LocaleCode = @LocaleCode
		   WHERE na.PortalID=@PortalID
		   AND ((@EditPermission = 1) OR (
				(@UserCanApprove = 1 OR na.Approved = 1)
				 AND (na.Active = 1 OR na.UserID=@UserID)
				 ))
		   AND na.HasPermissions = 0
		   AND na.PublishDate <= @CurrentDate
		   AND na.ExpireDate >= @CurrentDate
		   AND((@FilterAuthorOrAuthors = 1 AND na.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
		UNION ALL
		Select DISTINCT na.[ArticleID] FROM [dbo].[EasyDNNNews] as na
			 INNER JOIN [dbo].[EasyDNNNewsArticleUserPermissions] as aup ON na.ArticleID = aup.ArticleID
			 INNER JOIN [dbo].[EasyDNNNewsCategories] as cat ON na.ArticleID = cat.ArticleID
			 INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = cat.CategoryID AND cidl.Show = 1
			 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = na.ArticleID
			 INNER JOIN [dbo].[EasyDNNNewsSocialGroupItems] AS sgi ON sgi.ArticleID = na.ArticleID AND sgi.RoleID = @FilterByDNNGroupID
			 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
			 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = na.ArticleID AND ncl.LocaleCode = @LocaleCode
			 WHERE na.PortalID=@PortalID
			 AND ((@EditPermission = 1) OR (
				 ((@UserID = -1 AND aup.UserID IS NULL) OR (aup.UserID = @UserID))
				 AND aup.Show = 1
				 AND ((@UserCanApprove = 1) OR (na.Approved = 1))
				 AND (na.Active = 1 OR na.UserID=@UserID)
			 ))
			 AND na.HasPermissions = 1
		     AND na.PublishDate <= @CurrentDate
		     AND na.ExpireDate >= @CurrentDate
		   	 AND((@FilterAuthorOrAuthors = 1 AND na.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
		UNION
		Select DISTINCT na.[ArticleID] FROM [dbo].[EasyDNNNews] as na
			  INNER JOIN [dbo].[EasyDNNNewsArticleRolePermissions] as arp ON na.ArticleID = arp.ArticleID
			  INNER JOIN [dbo].[EasyDNNNewsCategories] as cat ON na.ArticleID = cat.ArticleID
			  INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = cat.CategoryID AND cidl.Show = 1
			  INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = na.ArticleID
			  INNER JOIN [dbo].[EasyDNNNewsSocialGroupItems] AS sgi ON sgi.ArticleID = na.ArticleID AND sgi.RoleID = @FilterByDNNGroupID
			  INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
			  INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = na.ArticleID AND ncl.LocaleCode = @LocaleCode
			  WHERE na.PortalID=@PortalID
			  AND ((@EditPermission = 1) OR (
					((@UserCanApprove = 1) OR (na.Approved = 1))
					AND (na.Active = 1 OR na.UserID=@UserID)
					AND arp.Show = 1
					AND arp.RoleID IN (SELECT [RoleID] FROM @UserInRoles)
					))
			  AND na.HasPermissions = 1
			  AND na.PublishDate <= @CurrentDate
		      AND na.ExpireDate >= @CurrentDate
			  AND((@FilterAuthorOrAuthors = 1 AND na.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))	 
		) 
		ORDER BY tempc.Position, n.PublishDate;
	
END
ELSE IF @FilterByDNNUserID <> 0
BEGIN
INSERT INTO @TempCategoryIDAndCount
SELECT CategoryID, Position, ParentCategory,
	CASE Show
	 WHEN 0 THEN 0
	 WHEN 1 THEN	
		CASE @AdminOrSuperUser
		WHEN 1 THEN
		(
		 SELECT count(n.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n	 
			 INNER JOIN [dbo].[EasyDNNNewsCategories]  AS c ON n.ArticleID = c.ArticleID AND c.CategoryID = Result.CategoryID
			 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
			 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
			 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
			 WHERE n.PublishDate <= @CurrentDate
			 AND n.ExpireDate >= @CurrentDate
			 AND n.PortalID = @PortalID
			 AND n.UserID = @FilterByDNNUserID 
		)
		WHEN 0 THEN
		(
		SELECT (
					(
						SELECT count(n.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n
						 INNER JOIN [dbo].[EasyDNNNewsCategories]  AS c ON n.ArticleID = c.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
						 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
						 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
						 WHERE n.PublishDate <= @CurrentDate
							 AND n.ExpireDate >= @CurrentDate
							 AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							 AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							 AND n.HasPermissions = 0
							 AND n.PortalID = @PortalID
							 AND n.UserID = @FilterByDNNUserID
					)
					 +
					(
						SELECT count(aup.[ArticleID]) FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
						 INNER JOIN [dbo].[EasyDNNNewsCategories]  AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
						 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
						 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
						 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
						 WHERE ((@UserID = -1 AND aup.UserID IS NULL) OR (aup.UserID = @UserID))
					 		AND n.PublishDate <= @CurrentDate
							AND n.ExpireDate >= @CurrentDate
							AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							AND n.HasPermissions = 1
							AND n.PortalID = @PortalID
							AND n.UserID = @FilterByDNNUserID 					 )	 
					+ 
					(
						CASE @UserID
						WHEN -1 THEN 0
						ELSE			
					(
						SELECT count(PerRoles.[ArticleID]) FROM 
						
						(SELECT DISTINCT arp.[ArticleID] FROM [dbo].[EasyDNNNewsArticleRolePermissions] as arp
						 INNER JOIN [dbo].[EasyDNNNewsCategories]  AS c ON c.ArticleID = arp.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = arp.ArticleID AND ncl.LocaleCode = @LocaleCode
						 WHERE arp.RoleID IN (SELECT RoleID FROM @UserInRoles)
						  AND arp.ArticleID NOT IN (
							SELECT aup.[ArticleID] FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
							INNER JOIN [dbo].[EasyDNNNewsCategories]  AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
							INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
							INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
							INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
							INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
								WHERE aup.UserID = @UserID
					 				AND n.PublishDate <= @CurrentDate
									AND n.ExpireDate >= @CurrentDate
									AND ((@UserCanApprove = 1) OR (n.Approved = 1))
									AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
									AND n.HasPermissions = 1
									AND n.PortalID = @PortalID
									AND n.UserID = @FilterByDNNUserID 
			  				)
						 ) as PerRoles 
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = PerRoles.ArticleID
						 WHERE n.PublishDate <= @CurrentDate
						 AND n.ExpireDate >= @CurrentDate
						 AND ((@UserCanApprove = 1) OR (n.Approved = 1))
						 AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
						 AND n.HasPermissions = 1
						 AND n.PortalID = @PortalID
						 AND n.UserID = @FilterByDNNUserID 						 )
			END
					)
				)
		)
		END		
	 END AS ''Count'',NewsModuleID,TabID
	FROM 
	(SELECT 
		ncl.[CategoryID],
		ncl.[Position],
		ncl.[ParentCategory],
		ncl.Show,
		CASE WHEN cl.[NewsModuleID] IS NULL THEN @DefaultModuleID ELSE cl.[NewsModuleID] END AS NewsModuleID,
		CASE WHEN tm.[TabID] IS NULL THEN @DefaultTabID ELSE tm.[TabID] END AS TabID
	FROM @tempMenuCats as ncl LEFT OUTER JOIN [dbo].[EasyDNNNewsCategoryLink] as cl
	ON ncl.CategoryID = cl.CategoryID AND cl.[SourceModuleID] = @MenuModuleID
	LEFT OUTER JOIN {databaseOwner}{objectQualifier}TabModules AS tm ON cl.NewsModuleID = tm.ModuleID) as Result

	SELECT n.ArticleID,n.Title,n.TitleLink,n.PublishDate,n.NumberOfViews,n.RatingValue,n.DateAdded,n.ExpireDate,n.LastModified,
	 n.HasPermissions, n.Active, n.Approved, n.NumberOfComments,n.UserID, c.[CategoryID], ncl.[Position], ncl.Count, ncl.NewsModuleID,ncl.TabID
	 FROM [dbo].[EasyDNNNews] as n
	  INNER JOIN [dbo].[EasyDNNNewsCategories] c ON n.ArticleID = c.ArticleID 
	  INNER JOIN @TempCategoryIDAndCount as ncl ON ncl.CategoryID = c.CategoryID
	  INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = c.CategoryID AND cidl.Show = 1 WHERE n.ArticleID IN(
		Select DISTINCT na.[ArticleID] FROM [dbo].[EasyDNNNews] as na
		INNER JOIN [dbo].[EasyDNNNewsCategories] as cat ON na.ArticleID = cat.ArticleID
		INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = cat.CategoryID AND cidl.Show = 1
		INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = na.ArticleID
		INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
		INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = na.ArticleID AND ncl.LocaleCode = @LocaleCode
		   WHERE na.PortalID=@PortalID
		   AND ((@EditPermission = 1) OR (
				(@UserCanApprove = 1 OR na.Approved = 1)
				 AND (na.Active = 1 OR na.UserID=@UserID)
				 ))
		   AND na.HasPermissions = 0
		   AND na.PublishDate <= @CurrentDate
		   AND na.ExpireDate >= @CurrentDate
		   AND((@FilterAuthorOrAuthors = 1 AND na.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
		UNION ALL
		Select DISTINCT na.[ArticleID] FROM [dbo].[EasyDNNNews] as na
			 INNER JOIN [dbo].[EasyDNNNewsArticleUserPermissions] as aup ON na.ArticleID = aup.ArticleID
			 INNER JOIN [dbo].[EasyDNNNewsCategories] as cat ON na.ArticleID = cat.ArticleID
			 INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = cat.CategoryID AND cidl.Show = 1
			 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = na.ArticleID
			 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
			 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = na.ArticleID AND ncl.LocaleCode = @LocaleCode
			 WHERE na.PortalID=@PortalID
			 AND ((@EditPermission = 1) OR (
				 ((@UserID = -1 AND aup.UserID IS NULL) OR (aup.UserID = @UserID))
				 AND aup.Show = 1
				 AND ((@UserCanApprove = 1) OR (na.Approved = 1))
				 AND (na.Active = 1 OR na.UserID=@UserID)
			 ))
			 AND na.HasPermissions = 1
		     AND na.PublishDate <= @CurrentDate
		     AND na.ExpireDate >= @CurrentDate
		   	 AND((@FilterAuthorOrAuthors = 1 AND na.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
		UNION
		Select DISTINCT na.[ArticleID] FROM [dbo].[EasyDNNNews] as na
			  INNER JOIN [dbo].[EasyDNNNewsArticleRolePermissions] as arp ON na.ArticleID = arp.ArticleID
			  INNER JOIN [dbo].[EasyDNNNewsCategories] as cat ON na.ArticleID = cat.ArticleID
			  INNER JOIN @tempMenuCats AS cidl ON cidl.CategoryID = cat.CategoryID AND cidl.Show = 1
			  INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = na.ArticleID
			  INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
			  INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = na.ArticleID AND ncl.LocaleCode = @LocaleCode
			  WHERE na.PortalID=@PortalID
			  AND ((@EditPermission = 1) OR (
					((@UserCanApprove = 1) OR (na.Approved = 1))
					AND (na.Active = 1 OR na.UserID=@UserID)
					AND arp.Show = 1
					AND arp.RoleID IN (SELECT [RoleID] FROM @UserInRoles)
					))
			  AND na.HasPermissions = 1
			  AND na.PublishDate <= @CurrentDate
		      AND na.ExpireDate >= @CurrentDate
			  AND((@FilterAuthorOrAuthors = 1 AND na.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))	 
		) 
		ORDER BY ncl.Position, n.PublishDate;
	
END

END' 
END
GO
/****** Object:  StoredProcedure [dbo].[EasyDNNNewsGetItemsForTreeView]    Script Date: 04/26/2013 09:40:53 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[EasyDNNNewsGetItemsForTreeView]') AND type in (N'P', N'PC'))
BEGIN
EXEC dbo.sp_executesql @statement = N'CREATE PROCEDURE [dbo].[EasyDNNNewsGetItemsForTreeView]
	@PortalID int,
	@UserID int,
	@MenuModuleID int,
	@DefaultTabID int,
    @DefaultModuleID int,
	@CurrentDate DateTime,
	@AdminOrSuperUser bit  = 0,
	@CountItems bit = 0,
	@IsSocialInstance bit = 0,
	@FilterByDNNUserID int = 0, -- filter by some UserID / not current user ID
	@FilterByDNNGroupID int = 0, -- filter by DNNGroup/RoleID / not profile GroupID
	@LocaleCode nvarchar(20) = '''',	
	@ShowAllAuthors bit = 1, -- filter postavka menija
	@CategoryFilterType tinyint = 0, --0 All categories, 1 - Selection, 2 - AutoAdd
	@HideUnlocalizedItems bit = 0,
	@PermissionSettingsSource tinyint = 0, -- None, 1 - portal, 2 - module
	@PermissionsModuleID int = 0 -- NewsModuleID
AS
SET NOCOUNT ON;
DECLARE @UserCanApprove bit;
SET @UserCanApprove = 0;
DECLARE @UserInRoles table (RoleID int NOT NULL PRIMARY KEY);
INSERT INTO @UserInRoles SELECT DISTINCT ur.[RoleID] FROM {databaseOwner}{objectQualifier}UserRoles AS ur INNER JOIN {databaseOwner}{objectQualifier}Roles AS r ON ur.RoleID = r.RoleID WHERE ur.UserID = @UserID AND r.PortalID = @PortalID AND (ur.ExpiryDate IS NULL OR ur.ExpiryDate > GETUTCDATE()) AND (ur.EffectiveDate IS NULL OR ur.EffectiveDate < GETUTCDATE());
DECLARE @UserViewCategories table (CategoryID int NOT NULL PRIMARY KEY); -- all categories which user can see based on permissions
DECLARE @UserViewCategoriesWithFilter table (CategoryID int NOT NULL PRIMARY KEY); -- all categories which user can see based on permissions and Module filter

DECLARE @SettingsSource bit; SET @SettingsSource = 1;
IF @AdminOrSuperUser = 1 OR @PermissionSettingsSource = 0
BEGIN
	INSERT INTO @UserViewCategories SELECT [CategoryID] FROM [dbo].[EasyDNNNewsCategoryList] WHERE PortalID = @PortalID;
END
ELSE IF @UserID = -1
BEGIN	
	IF @PermissionSettingsSource = 1 -- by portal
	BEGIN
		IF EXISTS (SELECT ShowAllCategories FROM [dbo].[EasyDNNNewsRolePremissionSettings] as rps WHERE rps.PortalID = @PortalID  AND rps.ModuleID IS NULL AND rps.RoleID IS NULL AND rps.ShowAllCategories = 1)
		BEGIN
			INSERT INTO @UserViewCategories SELECT [CategoryID] FROM [dbo].[EasyDNNNewsCategoryList] WHERE PortalID = @PortalID;
		END
		ELSE
		BEGIN
			INSERT INTO @UserViewCategories
			SELECT rpsc.[CategoryID] FROM  [dbo].[EasyDNNNewsRolePremissionsShowCategories] as rpsc 
			INNER JOIN [dbo].[EasyDNNNewsRolePremissionSettings] as rps ON rps.PremissionSettingsID = rpsc.PremissionSettingsID
			WHERE rps.PortalID = @PortalID  AND rps.ModuleID IS NULL AND rps.RoleID IS NULL;
		END
	END
	ELSE -- by module
	BEGIN
		SELECT @SettingsSource = PermissionsPMSource FROM [dbo].[EasyDNNNewsModuleSettings] WHERE ModuleID = @PermissionsModuleID;
		IF @SettingsSource = 1
		BEGIN
			IF EXISTS (SELECT ShowAllCategories FROM [dbo].[EasyDNNNewsRolePremissionSettings] as rps WHERE rps.PortalID = @PortalID  AND rps.ModuleID IS NULL AND rps.RoleID IS NULL AND rps.ShowAllCategories = 1)
			BEGIN
				INSERT INTO @UserViewCategories SELECT [CategoryID] FROM [dbo].[EasyDNNNewsCategoryList] WHERE PortalID = @PortalID;
			END
			ELSE
			BEGIN
				INSERT INTO @UserViewCategories
				SELECT rpsc.[CategoryID] FROM  [dbo].[EasyDNNNewsRolePremissionsShowCategories] as rpsc 
				INNER JOIN [dbo].[EasyDNNNewsRolePremissionSettings] as rps ON rps.PremissionSettingsID = rpsc.PremissionSettingsID
				WHERE rps.PortalID = @PortalID  AND rps.ModuleID IS NULL AND rps.RoleID IS NULL;
			END
		END
		ELSE
		BEGIN
			IF EXISTS (SELECT ShowAllCategories FROM [dbo].[EasyDNNNewsRolePremissionSettings] as rps WHERE rps.PortalID = @PortalID AND rps.ModuleID = @PermissionsModuleID AND rps.RoleID IS NULL AND rps.ShowAllCategories = 1)
			BEGIN
				INSERT INTO @UserViewCategories SELECT [CategoryID] FROM [dbo].[EasyDNNNewsCategoryList] WHERE PortalID = @PortalID;
			END
			ELSE
			BEGIN
				INSERT INTO @UserViewCategories
				SELECT rpsc.[CategoryID] FROM [dbo].[EasyDNNNewsRolePremissionsShowCategories] as rpsc
				INNER JOIN [dbo].[EasyDNNNewsRolePremissionSettings] as rps ON rps.PremissionSettingsID = rpsc.PremissionSettingsID
				WHERE rps.PortalID = @PortalID AND rps.ModuleID = @PermissionsModuleID AND rps.RoleID IS NULL;
			END
		END
	END
END
ELSE -- registrirani korisnik
BEGIN
	IF @PermissionSettingsSource = 1 -- by portal
	BEGIN
		IF EXISTS (
				SELECT TOP (1) ShowAllCategories FROM [dbo].[EasyDNNNewsRolePremissionSettings] as rps
					INNER JOIN @UserInRoles as uir ON rps.RoleID = uir.RoleID
					WHERE rps.PortalID = @PortalID AND rps.ModuleID IS NULL AND rps.ShowAllCategories = 1
				UNION
				SELECT ShowAllCategories FROM [dbo].[EasyDNNNewsUserPremissionSettings] as ups
				WHERE ups.UserID = @UserID AND ups.PortalID = @PortalID AND ups.ModuleID IS NULL AND ups.ShowAllCategories = 1
		)
		BEGIN
			INSERT INTO @UserViewCategories SELECT [CategoryID] FROM [dbo].[EasyDNNNewsCategoryList] WHERE PortalID = @PortalID;
		END
		ELSE
		BEGIN
			INSERT INTO @UserViewCategories
			SELECT rpsc.[CategoryID] FROM [dbo].[EasyDNNNewsRolePremissionsShowCategories] as rpsc
			INNER JOIN [dbo].[EasyDNNNewsRolePremissionSettings] as rps ON rps.PremissionSettingsID = rpsc.PremissionSettingsID
			INNER JOIN @UserInRoles as uir ON rps.RoleID = uir.RoleID
			WHERE rps.PortalID = @PortalID AND rps.ModuleID IS NULL GROUP BY rpsc.[CategoryID]
			UNION
			SELECT upsc.[CategoryID] FROM [dbo].[EasyDNNNewsUserPremissionsShowCategories] as upsc
			INNER JOIN [dbo].[EasyDNNNewsUserPremissionSettings] as ups ON ups.PremissionSettingsID = upsc.PremissionSettingsID
			WHERE ups.UserID = @UserID AND ups.PortalID = @PortalID AND ups.ModuleID IS NULL GROUP BY upsc.[CategoryID];
		END
	END
	ELSE -- by module
	BEGIN
		SELECT @SettingsSource = PermissionsPMSource FROM [dbo].[EasyDNNNewsModuleSettings] WHERE ModuleID = @PermissionsModuleID;
		IF @SettingsSource = 1
		BEGIN
			IF EXISTS (
				SELECT TOP (1) ShowAllCategories FROM [dbo].[EasyDNNNewsRolePremissionSettings] as rps
					INNER JOIN @UserInRoles as uir ON rps.RoleID = uir.RoleID
					WHERE rps.PortalID = @PortalID AND rps.ModuleID IS NULL AND rps.ShowAllCategories = 1
				UNION
				SELECT ShowAllCategories FROM [dbo].[EasyDNNNewsUserPremissionSettings] as ups
				WHERE ups.UserID = @UserID AND ups.PortalID = @PortalID AND ups.ModuleID IS NULL AND ups.ShowAllCategories = 1
			)
			BEGIN
				INSERT INTO @UserViewCategories SELECT [CategoryID] FROM [dbo].[EasyDNNNewsCategoryList] WHERE PortalID = @PortalID;
			END
			ELSE
			BEGIN
				INSERT INTO @UserViewCategories
				SELECT rpsc.[CategoryID] FROM [dbo].[EasyDNNNewsRolePremissionsShowCategories] as rpsc
				INNER JOIN [dbo].[EasyDNNNewsRolePremissionSettings] as rps ON rps.PremissionSettingsID = rpsc.PremissionSettingsID
				INNER JOIN @UserInRoles as uir ON rps.RoleID = uir.RoleID
				WHERE rps.PortalID = @PortalID AND rps.ModuleID IS NULL GROUP BY rpsc.[CategoryID]
				UNION
				SELECT upsc.[CategoryID] FROM [dbo].[EasyDNNNewsUserPremissionsShowCategories] as upsc
				INNER JOIN [dbo].[EasyDNNNewsUserPremissionSettings] as ups ON ups.PremissionSettingsID = upsc.PremissionSettingsID
				WHERE ups.UserID = @UserID AND ups.PortalID = @PortalID AND ups.ModuleID IS NULL GROUP BY upsc.[CategoryID];
			END
		END
		ELSE
		BEGIN
			IF EXISTS (
				SELECT TOP (1) ShowAllCategories FROM [dbo].[EasyDNNNewsRolePremissionSettings] as rps
					INNER JOIN @UserInRoles as uir ON rps.RoleID = uir.RoleID
					WHERE rps.PortalID = @PortalID AND rps.ModuleID = @PermissionsModuleID AND rps.ShowAllCategories = 1
				UNION
				SELECT ShowAllCategories FROM [dbo].[EasyDNNNewsUserPremissionSettings] as ups
				WHERE ups.UserID = @UserID AND ups.PortalID = @PortalID AND ups.ModuleID = @PermissionsModuleID AND ups.ShowAllCategories = 1
			)
			BEGIN
				INSERT INTO @UserViewCategories SELECT [CategoryID] FROM [dbo].[EasyDNNNewsCategoryList] WHERE PortalID = @PortalID;
			END
			ELSE
			BEGIN
				INSERT INTO @UserViewCategories
				SELECT rpsc.[CategoryID] FROM [dbo].[EasyDNNNewsRolePremissionsShowCategories] as rpsc
				INNER JOIN [dbo].[EasyDNNNewsRolePremissionSettings] as rps ON rps.PremissionSettingsID = rpsc.PremissionSettingsID
				INNER JOIN @UserInRoles as uir ON rps.RoleID = uir.RoleID
				WHERE rps.PortalID = @PortalID AND rps.ModuleID = @PermissionsModuleID GROUP BY rpsc.[CategoryID]
				UNION
				SELECT upsc.[CategoryID] FROM [dbo].[EasyDNNNewsUserPremissionsShowCategories] as upsc
				INNER JOIN [dbo].[EasyDNNNewsUserPremissionSettings] as ups ON ups.PremissionSettingsID = upsc.PremissionSettingsID
				WHERE ups.UserID = @UserID AND ups.PortalID = @PortalID AND ups.ModuleID = @PermissionsModuleID GROUP BY upsc.[CategoryID];
			END
		END
	END
END

IF @CategoryFilterType = 0 -- 0 All categories
BEGIN
	INSERT INTO @UserViewCategoriesWithFilter SELECT [CategoryID] FROM @UserViewCategories;
END
ELSE IF @CategoryFilterType = 1 -- 1 - Selection
BEGIN
		INSERT INTO @UserViewCategoriesWithFilter 
		SELECT cl.[CategoryID] FROM @UserViewCategories as cl
		INNER JOIN [dbo].[EasyDNNNewsModuleCategoryItems] AS mci ON mci.CategoryID = cl.CategoryID AND mci.ModuleID = @MenuModuleID
END
ELSE IF @CategoryFilterType = 2 -- 2 - AutoAdd
BEGIN
	WITH hierarchy AS(
		SELECT [CategoryID], [ParentCategory]
		FROM EasyDNNNewsCategoryList AS cl
		WHERE (cl.ParentCategory IN (SELECT [CategoryID] FROM [dbo].[EasyDNNNewsModuleCategoryItems] WHERE ModuleID = @MenuModuleID) OR cl.CategoryID IN (SELECT [CategoryID] FROM [dbo].[EasyDNNNewsModuleCategoryItems] WHERE ModuleID = @MenuModuleID)) AND PortalID = @PortalID
		UNION ALL
		SELECT c.[CategoryID], c.[ParentCategory]
		FROM [dbo].[EasyDNNNewsCategoryList] AS c INNER JOIN hierarchy AS p ON c.ParentCategory = p.CategoryID WHERE c.PortalID = @PortalID
		)
	INSERT INTO @UserViewCategoriesWithFilter SELECT DISTINCT uvc.CategoryID FROM hierarchy as nfc INNER JOIN @UserViewCategories as uvc ON uvc.CategoryID = nfc.CategoryID;
END

DECLARE @FilterBySocialGroup bit;
SET @FilterBySocialGroup = 0;
DECLARE @FilterAuthorOrAuthors bit;
SET @FilterAuthorOrAuthors = 0;

DECLARE @TempAuthorsIDList table (UserID int NOT NULL PRIMARY KEY);
IF @IsSocialInstance = 1
	BEGIN
		IF @FilterByDNNGroupID <> 0
		BEGIN	
			SET @FilterBySocialGroup = 1;
		END
	END
ELSE
BEGIN
	IF @ShowAllAuthors = 0
	BEGIN
		SET @FilterAuthorOrAuthors = 1;
		INSERT INTO @TempAuthorsIDList
		SELECT [UserID] FROM [dbo].[EasyDNNNewsModuleAuthorsItems] AS mai WHERE mai.ModuleID = @MenuModuleID
		UNION 
		SELECT [UserID] FROM [dbo].[EasyDNNNewsAuthorProfile] AS ap 
			INNER JOIN [dbo].[EasyDNNNewsAutorGroupItems] AS agi ON ap.AuthorProfileID = agi.AuthorProfileID
			INNER JOIN [dbo].[EasyDNNNewsModuleGroupItems] AS mgi ON mgi.GroupID = agi.GroupID
			WHERE mgi.ModuleID = @MenuModuleID
	END
END

DECLARE @tempMenuCats TABLE(
	[CategoryID] int,
	[PortalID] int,
	[CategoryName] nvarchar(200),
	[Position] int,
	[ParentCategory] int,
	[Level] int,
	[CategoryURL] nvarchar(1500),
	[CategoryImage] nvarchar(1500),
	[CategoryText] ntext,[Show] bit)

IF @LocaleCode <> ''''
BEGIN
	WITH LocCategories([CategoryID],[PortalID],[CategoryName],[Position],[ParentCategory],[Level],[CategoryURL],[CategoryImage],[CategoryText]) AS 
	(
		SELECT Cat.[CategoryID],Cat.[PortalID],cl.[Title] AS CategoryName,Cat.[Position],Cat.[ParentCategory],Cat.[Level],Cat.[CategoryURL],Cat.[CategoryImage],cl.[CategoryText] FROM EasyDNNNewsCategoryList AS Cat INNER JOIN @UserViewCategoriesWithFilter cwf ON cwf.CategoryID = Cat.CategoryID INNER JOIN EasyDNNNewsCategoryLocalization AS cl ON cwf.CategoryID = cl.CategoryID WHERE Cat.PortalID = @PortalID AND cl.LocaleCode = @LocaleCode
	),
	NotLocCategories([CategoryID],[PortalID],[CategoryName],[Position],[ParentCategory],[Level],[CategoryURL],[CategoryImage],[CategoryText]) AS 
	(
		SELECT Cat.* FROM EasyDNNNewsCategoryList AS Cat INNER JOIN @UserViewCategoriesWithFilter cwf ON cwf.CategoryID = Cat.CategoryID WHERE Cat.PortalID = @PortalID AND Cat.CategoryID NOT IN (SELECT lctemp.CategoryID FROM LocCategories as lctemp)
	)
	INSERT INTO @tempMenuCats SELECT [CategoryID],[PortalID],[CategoryName],[Position],[ParentCategory],[Level],[CategoryURL],[CategoryImage],[CategoryText],''1'' AS Show FROM (SELECT * FROM LocCategories UNION ALL SELECT * FROM NotLocCategories) as result
END
ELSE
BEGIN
	
INSERT @tempMenuCats SELECT
 [CategoryID],[PortalID],[CategoryName],[Position],[ParentCategory],[Level],[CategoryURL],[CategoryImage],[CategoryText],''1'' AS Show
 FROM [dbo].[EasyDNNNewsCategoryList] AS cat WHERE cat.CategoryID in (SELECT CategoryID FROM @UserViewCategoriesWithFilter) AND PortalID = @PortalID;

END

INSERT @tempMenuCats SELECT
 [CategoryID],[PortalID],[CategoryName],[Position],[ParentCategory],[Level],[CategoryURL],[CategoryImage],[CategoryText],''0'' AS Show
  FROM [dbo].[EasyDNNNewsCategoryList] WHERE PortalID = @PortalID AND CategoryID not in (SELECT CategoryID FROM @UserViewCategoriesWithFilter);
  
SELECT TOP 1 @DefaultTabID = TabID FROM {databaseOwner}{objectQualifier}TabModules WHERE ModuleID = @DefaultModuleID;

IF @CountItems = 0
BEGIN 
	SELECT ncl.[CategoryID],ncl.[PortalID],ncl.[CategoryName],ncl.[Position],ncl.[ParentCategory],ncl.[Level],ncl.[CategoryURL],ncl.[CategoryImage],ncl.[CategoryText],ncl.Show,
	0 AS ''Count'',
		CASE WHEN cl.[NewsModuleID] IS NULL THEN @DefaultModuleID ELSE cl.[NewsModuleID] END AS NewsModuleID,
		CASE WHEN tm.[TabID] IS NULL THEN @DefaultTabID ELSE tm.[TabID] END AS TabID
	FROM @tempMenuCats as ncl LEFT OUTER JOIN [dbo].[EasyDNNNewsCategoryLink] as cl
	ON ncl.CategoryID = cl.CategoryID AND cl.[SourceModuleID] = @MenuModuleID
	LEFT OUTER JOIN {databaseOwner}{objectQualifier}TabModules AS tm ON cl.NewsModuleID = tm.ModuleID
	ORDER BY Position ASC, ParentCategory ASC;
END
ELSE
BEGIN

IF @HideUnlocalizedItems = 0
BEGIN

IF @IsSocialInstance = 0
BEGIN
SELECT *,
	CASE Show
	 WHEN 0 THEN 0
	 WHEN 1 THEN	
		CASE @AdminOrSuperUser
		WHEN 1 THEN
		(
		 SELECT count(n.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n
			 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON n.ArticleID = c.ArticleID AND c.CategoryID = Result.CategoryID
			 WHERE n.PublishDate <= @CurrentDate
			 AND n.ExpireDate >= @CurrentDate
			 AND n.PortalID = @PortalID
			 AND((@FilterAuthorOrAuthors = 1 AND n.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))			 
		)
		WHEN 0 THEN
		(
		SELECT (
					(
						SELECT count(n.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON n.ArticleID = c.ArticleID AND c.CategoryID = Result.CategoryID
						 WHERE n.PublishDate <= @CurrentDate
							 AND n.ExpireDate >= @CurrentDate
							 AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							 AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							 AND n.HasPermissions = 0
							 AND n.PortalID = @PortalID
							 AND((@FilterAuthorOrAuthors = 1 AND n.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
					 )
					 +
					(
						SELECT count(aup.[ArticleID]) FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
						 WHERE ((@UserID = -1 AND aup.UserID IS NULL) OR (aup.UserID = @UserID))
					 		AND n.PublishDate <= @CurrentDate
							AND n.ExpireDate >= @CurrentDate
							AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							AND n.HasPermissions = 1
							AND n.PortalID = @PortalID
							AND((@FilterAuthorOrAuthors = 1 AND n.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
					 )	 
					+ 
					(
						CASE @UserID
						WHEN -1 THEN 0
						ELSE			
					(
						SELECT count(PerRoles.[ArticleID]) FROM 
						
						(SELECT DISTINCT arp.[ArticleID] FROM [dbo].[EasyDNNNewsArticleRolePermissions] as arp
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = arp.ArticleID AND c.CategoryID = Result.CategoryID
						 WHERE arp.RoleID IN (SELECT RoleID FROM @UserInRoles)
						  AND arp.ArticleID NOT IN (
							SELECT aup.[ArticleID] FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
							INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
							INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
								WHERE aup.UserID = @UserID
					 				AND n.PublishDate <= @CurrentDate
									AND n.ExpireDate >= @CurrentDate
									AND ((@UserCanApprove = 1) OR (n.Approved = 1))
									AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
									AND n.HasPermissions = 1
									AND n.PortalID = @PortalID
									AND((@FilterAuthorOrAuthors = 1 AND n.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
							)
						 ) as PerRoles 
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = PerRoles.ArticleID
						 WHERE n.PublishDate <= @CurrentDate
						 AND n.ExpireDate >= @CurrentDate
						 AND ((@UserCanApprove = 1) OR (n.Approved = 1))
						 AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
						 AND n.HasPermissions = 1
						 AND n.PortalID = @PortalID
						 AND((@FilterAuthorOrAuthors = 1 AND n.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
						 )
			END
					)
				)
		)
		END		
	 END AS ''Count''
	FROM 
	(SELECT 
	ncl.[CategoryID],
	ncl.[PortalID],
	ncl.[CategoryName],
	ncl.[Position],
	ncl.[ParentCategory],
	ncl.[Level],
	ncl.[CategoryURL],
	ncl.[CategoryImage],
	ncl.[CategoryText],
	ncl.Show,
		CASE WHEN cl.[NewsModuleID] IS NULL THEN @DefaultModuleID ELSE cl.[NewsModuleID] END AS NewsModuleID,
		CASE WHEN tm.[TabID] IS NULL THEN @DefaultTabID ELSE tm.[TabID] END AS TabID
	FROM @tempMenuCats as ncl LEFT OUTER JOIN [dbo].[EasyDNNNewsCategoryLink] as cl
	ON ncl.CategoryID = cl.CategoryID AND cl.[SourceModuleID] = @MenuModuleID
	LEFT OUTER JOIN {databaseOwner}{objectQualifier}TabModules AS tm ON cl.NewsModuleID = tm.ModuleID) as Result
	ORDER BY Position ASC, ParentCategory ASC	
END
ELSE IF @FilterBySocialGroup = 1
BEGIN
SELECT *,
	CASE Show
	 WHEN 0 THEN 0
	 WHEN 1 THEN	
		CASE @AdminOrSuperUser
		WHEN 1 THEN
		(
		 SELECT count(n.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n
			 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON n.ArticleID = c.ArticleID AND c.CategoryID = Result.CategoryID
			 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
			 INNER JOIN [dbo].[EasyDNNNewsSocialGroupItems] AS sgi ON sgi.ArticleID = n.ArticleID AND sgi.RoleID = @FilterByDNNGroupID
			 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
			 WHERE  n.PublishDate <= @CurrentDate
				AND n.ExpireDate >= @CurrentDate
				AND n.PortalID = @PortalID
		)
		WHEN 0 THEN
		(
		SELECT (
					(
						SELECT count(n.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n
						INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON n.ArticleID = c.ArticleID AND c.CategoryID = Result.CategoryID
						INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
						INNER JOIN [dbo].[EasyDNNNewsSocialGroupItems] AS sgi ON sgi.ArticleID = n.ArticleID AND sgi.RoleID = @FilterByDNNGroupID
						INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
						 WHERE n.PublishDate <= @CurrentDate
							 AND n.ExpireDate >= @CurrentDate
							 AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							 AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							 AND n.HasPermissions = 0
							 AND n.PortalID = @PortalID
					 )
					 +
					(
						SELECT count(aup.[ArticleID]) FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
						 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
						 INNER JOIN EasyDNNNewsSocialGroupItems AS sgi ON sgi.ArticleID = n.ArticleID AND sgi.RoleID = @FilterByDNNGroupID
						 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
						 WHERE ((@UserID = -1 AND aup.UserID IS NULL) OR (aup.UserID = @UserID))
					 		AND n.PublishDate <= @CurrentDate
							AND n.ExpireDate >= @CurrentDate
							AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							AND n.HasPermissions = 1
							AND n.PortalID = @PortalID
					 )	 
					+ 
					(
						CASE @UserID
						WHEN -1 THEN 0
						ELSE			
					(
						SELECT count(PerRoles.[ArticleID]) FROM 
						
						(SELECT DISTINCT arp.[ArticleID] FROM [dbo].[EasyDNNNewsArticleRolePermissions] as arp
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = arp.ArticleID AND c.CategoryID = Result.CategoryID
						 WHERE arp.RoleID IN (SELECT RoleID FROM @UserInRoles)
						  AND arp.ArticleID NOT IN (
							SELECT aup.[ArticleID] FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
							INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
							INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
							INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
							INNER JOIN [dbo].[EasyDNNNewsSocialGroupItems] AS sgi ON sgi.ArticleID = n.ArticleID AND sgi.RoleID = @FilterByDNNGroupID
							INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
								WHERE aup.UserID = @UserID
					 				AND n.PublishDate <= @CurrentDate
									AND n.ExpireDate >= @CurrentDate
									AND ((@UserCanApprove = 1) OR (n.Approved = 1))
									AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
									AND n.HasPermissions = 1
									AND n.PortalID = @PortalID
							)
						 ) as PerRoles 
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = PerRoles.ArticleID
						 WHERE n.PublishDate <= @CurrentDate
						 AND n.ExpireDate >= @CurrentDate
						 AND ((@UserCanApprove = 1) OR (n.Approved = 1))
						 AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
						 AND n.HasPermissions = 1
						 AND n.PortalID = @PortalID
						 )
			END
					)
				)
		)
		END		
	 END AS ''Count''
	FROM 
	(SELECT 
	ncl.[CategoryID],
	ncl.[PortalID],
	ncl.[CategoryName],
	ncl.[Position],
	ncl.[ParentCategory],
	ncl.[Level],
	ncl.[CategoryURL],
	ncl.[CategoryImage],
	ncl.[CategoryText],
	ncl.Show,
		CASE WHEN cl.[NewsModuleID] IS NULL THEN @DefaultModuleID ELSE cl.[NewsModuleID] END AS NewsModuleID,
		CASE WHEN tm.[TabID] IS NULL THEN @DefaultTabID ELSE tm.[TabID] END AS TabID
	FROM @tempMenuCats as ncl LEFT OUTER JOIN [dbo].[EasyDNNNewsCategoryLink] as cl
	ON ncl.CategoryID = cl.CategoryID AND cl.[SourceModuleID] = @MenuModuleID
	LEFT OUTER JOIN {databaseOwner}{objectQualifier}TabModules AS tm ON cl.NewsModuleID = tm.ModuleID) as Result
	ORDER BY Position ASC, ParentCategory ASC	
END
ELSE IF @FilterByDNNUserID <> 0
BEGIN
SELECT *,
	CASE Show
	 WHEN 0 THEN 0
	 WHEN 1 THEN	
		CASE @AdminOrSuperUser
		WHEN 1 THEN
		(
		 SELECT count(n.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n
		 
			 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON n.ArticleID = c.ArticleID
			 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID AND c.CategoryID = Result.CategoryID
			 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
			 WHERE  n.PublishDate <= @CurrentDate
				AND n.ExpireDate >= @CurrentDate
				AND n.PortalID = @PortalID
				AND n.UserID = @FilterByDNNUserID 
		)
		WHEN 0 THEN
		(
		SELECT (
					(
						SELECT count(n.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON n.ArticleID = c.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
						 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
						 WHERE n.PublishDate <= @CurrentDate
							 AND n.ExpireDate >= @CurrentDate
							 AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							 AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							 AND n.HasPermissions = 0
							 AND n.PortalID = @PortalID
							 AND n.UserID = @FilterByDNNUserID
					)
					 +
					(
						SELECT count(aup.[ArticleID]) FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
						 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
						 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
						 WHERE ((@UserID = -1 AND aup.UserID IS NULL) OR (aup.UserID = @UserID))
					 		AND n.PublishDate <= @CurrentDate
							AND n.ExpireDate >= @CurrentDate
							AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							AND n.HasPermissions = 1
							AND n.PortalID = @PortalID
							AND n.UserID = @FilterByDNNUserID 					 )	 
					+ 
					(
						CASE @UserID
						WHEN -1 THEN 0
						ELSE			
					(
						SELECT count(PerRoles.[ArticleID]) FROM 
						
						(SELECT DISTINCT arp.[ArticleID] FROM [dbo].[EasyDNNNewsArticleRolePermissions] as arp
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = arp.ArticleID AND c.CategoryID = Result.CategoryID
						 WHERE arp.RoleID IN (SELECT RoleID FROM @UserInRoles)
						  AND arp.ArticleID NOT IN (
							SELECT aup.[ArticleID] FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
							INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
							INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
							INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
							INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
								WHERE aup.UserID = @UserID
					 				AND n.PublishDate <= @CurrentDate
									AND n.ExpireDate >= @CurrentDate
									AND ((@UserCanApprove = 1) OR (n.Approved = 1))
									AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
									AND n.HasPermissions = 1
									AND n.PortalID = @PortalID
									AND n.UserID = @FilterByDNNUserID 
			  				)
						 ) as PerRoles 
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = PerRoles.ArticleID
						 WHERE n.PublishDate <= @CurrentDate
						 AND n.ExpireDate >= @CurrentDate
						 AND ((@UserCanApprove = 1) OR (n.Approved = 1))
						 AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
						 AND n.HasPermissions = 1
						 AND n.PortalID = @PortalID
						 AND n.UserID = @FilterByDNNUserID 						 )
			END
					)
				)
		)
		END		
	 END AS ''Count''
	FROM 
	(SELECT 
	ncl.[CategoryID],
	ncl.[PortalID],
	ncl.[CategoryName],
	ncl.[Position],
	ncl.[ParentCategory],
	ncl.[Level],
	ncl.[CategoryURL],
	ncl.[CategoryImage],
	ncl.[CategoryText],
	ncl.Show,
		CASE WHEN cl.[NewsModuleID] IS NULL THEN @DefaultModuleID ELSE cl.[NewsModuleID] END AS NewsModuleID,
		CASE WHEN tm.[TabID] IS NULL THEN @DefaultTabID ELSE tm.[TabID] END AS TabID
	FROM @tempMenuCats as ncl LEFT OUTER JOIN [dbo].[EasyDNNNewsCategoryLink] as cl
	ON ncl.CategoryID = cl.CategoryID AND cl.[SourceModuleID] = @MenuModuleID
	LEFT OUTER JOIN {databaseOwner}{objectQualifier}TabModules AS tm ON cl.NewsModuleID = tm.ModuleID) as Result
	ORDER BY Position ASC, ParentCategory ASC
END
END

ELSE
BEGIN

IF @IsSocialInstance = 0
BEGIN
SELECT *,
	CASE Show
	 WHEN 0 THEN 0
	 WHEN 1 THEN	
		CASE @AdminOrSuperUser
		WHEN 1 THEN
		(
		 SELECT count(c.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n
			 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON n.ArticleID = c.ArticleID AND c.CategoryID = Result.CategoryID
			 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
			 WHERE n.PublishDate <= @CurrentDate
				AND n.ExpireDate >= @CurrentDate
				AND n.PortalID = @PortalID
				AND((@FilterAuthorOrAuthors = 1 AND n.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))		 
		)
		WHEN 0 THEN
		(
		SELECT (
					(
						SELECT count(n.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON n.ArticleID = c.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
						 WHERE n.PublishDate <= @CurrentDate
							 AND n.ExpireDate >= @CurrentDate
							 AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							 AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							 AND n.HasPermissions = 0
							 AND n.PortalID = @PortalID
							 AND((@FilterAuthorOrAuthors = 1 AND n.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
					 )
					 +
					(
						SELECT count(aup.[ArticleID]) FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
						 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
						 WHERE ((@UserID = -1 AND aup.UserID IS NULL) OR (aup.UserID = @UserID))
					 		AND n.PublishDate <= @CurrentDate
							AND n.ExpireDate >= @CurrentDate
							AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							AND n.HasPermissions = 1
							AND n.PortalID = @PortalID
							AND((@FilterAuthorOrAuthors = 1 AND n.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
					 )	 
					+ 
					(
						CASE @UserID
						WHEN -1 THEN 0
						ELSE			
					(
						SELECT count(PerRoles.[ArticleID]) FROM 
						
						(SELECT DISTINCT arp.[ArticleID] FROM [dbo].[EasyDNNNewsArticleRolePermissions] as arp
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = arp.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = arp.ArticleID AND ncl.LocaleCode = @LocaleCode
						 WHERE arp.RoleID IN (SELECT RoleID FROM @UserInRoles)
						  AND arp.ArticleID NOT IN (
							SELECT aup.[ArticleID] FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
							INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
							INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
							INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
								WHERE aup.UserID = @UserID
					 				AND n.PublishDate <= @CurrentDate
									AND n.ExpireDate >= @CurrentDate
									AND ((@UserCanApprove = 1) OR (n.Approved = 1))
									AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
									AND n.HasPermissions = 1
									AND n.PortalID = @PortalID
									AND((@FilterAuthorOrAuthors = 1 AND n.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
							)
						 ) as PerRoles 
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = PerRoles.ArticleID
						 WHERE n.PublishDate <= @CurrentDate
							AND n.ExpireDate >= @CurrentDate
							AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							AND n.HasPermissions = 1
							AND n.PortalID = @PortalID
							AND((@FilterAuthorOrAuthors = 1 AND n.UserID IN (SELECT UserID FROM @TempAuthorsIDList)) OR (@FilterAuthorOrAuthors = 0))
						 )
			END
					)
				)
		)
		END		
	 END AS ''Count''
	FROM 
	(SELECT 
	ncl.[CategoryID],
	ncl.[PortalID],
	ncl.[CategoryName],
	ncl.[Position],
	ncl.[ParentCategory],
	ncl.[Level],
	ncl.[CategoryURL],
	ncl.[CategoryImage],
	ncl.[CategoryText],
	ncl.Show,
		CASE WHEN cl.[NewsModuleID] IS NULL THEN @DefaultModuleID ELSE cl.[NewsModuleID] END AS NewsModuleID,
		CASE WHEN tm.[TabID] IS NULL THEN @DefaultTabID ELSE tm.[TabID] END AS TabID
	FROM @tempMenuCats as ncl LEFT OUTER JOIN [dbo].[EasyDNNNewsCategoryLink] as cl
	ON ncl.CategoryID = cl.CategoryID AND cl.[SourceModuleID] = @MenuModuleID
	LEFT OUTER JOIN {databaseOwner}{objectQualifier}TabModules AS tm ON cl.NewsModuleID = tm.ModuleID) as Result
	ORDER BY Position ASC, ParentCategory ASC
END
ELSE IF @FilterBySocialGroup = 1
BEGIN
SELECT *,
	CASE Show
	 WHEN 0 THEN 0
	 WHEN 1 THEN	
		CASE @AdminOrSuperUser
		WHEN 1 THEN
		(
		 SELECT count(n.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n
			 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON n.ArticleID = c.ArticleID AND c.CategoryID = Result.CategoryID
			 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
			 INNER JOIN [dbo].[EasyDNNNewsSocialGroupItems] AS sgi ON sgi.ArticleID = n.ArticleID AND sgi.RoleID = @FilterByDNNGroupID
			 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
			 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
			 WHERE n.PublishDate <= @CurrentDate
				AND n.ExpireDate >= @CurrentDate
				AND n.PortalID = @PortalID
		)
		WHEN 0 THEN
		(
		SELECT (
					(
						SELECT count(n.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n
						INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON n.ArticleID = c.ArticleID AND c.CategoryID = Result.CategoryID
						INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
						INNER JOIN [dbo].[EasyDNNNewsSocialGroupItems] AS sgi ON sgi.ArticleID = n.ArticleID AND sgi.RoleID = @FilterByDNNGroupID
						INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
						INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
						 WHERE n.PublishDate <= @CurrentDate
							 AND n.ExpireDate >= @CurrentDate
							 AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							 AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							 AND n.HasPermissions = 0
							 AND n.PortalID = @PortalID
					 )
					 +
					(
						SELECT count(aup.[ArticleID]) FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
						 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
						 INNER JOIN [dbo].[EasyDNNNewsSocialGroupItems] AS sgi ON sgi.ArticleID = n.ArticleID AND sgi.RoleID = @FilterByDNNGroupID
						 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
						 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
						 WHERE ((@UserID = -1 AND aup.UserID IS NULL) OR (aup.UserID = @UserID))
					 		AND n.PublishDate <= @CurrentDate
							AND n.ExpireDate >= @CurrentDate
							AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							AND n.HasPermissions = 1
							AND n.PortalID = @PortalID
					 )	 
					+ 
					(
						CASE @UserID
						WHEN -1 THEN 0
						ELSE			
					(
						SELECT count(PerRoles.[ArticleID]) FROM 
						
						(SELECT DISTINCT arp.[ArticleID] FROM [dbo].[EasyDNNNewsArticleRolePermissions] as arp
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = arp.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = arp.ArticleID AND ncl.LocaleCode = @LocaleCode
						 WHERE arp.RoleID IN (SELECT RoleID FROM @UserInRoles)
						  AND arp.ArticleID NOT IN (
							SELECT aup.[ArticleID] FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
							INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
							INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
							INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
							INNER JOIN [dbo].[EasyDNNNewsSocialGroupItems] AS sgi ON sgi.ArticleID = n.ArticleID AND sgi.RoleID = @FilterByDNNGroupID
							INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
							INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
								WHERE aup.UserID = @UserID
					 				AND n.PublishDate <= @CurrentDate
									AND n.ExpireDate >= @CurrentDate
									AND ((@UserCanApprove = 1) OR (n.Approved = 1))
									AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
									AND n.HasPermissions = 1
									AND n.PortalID = @PortalID
							)
						 ) as PerRoles 
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = PerRoles.ArticleID
						 WHERE n.PublishDate <= @CurrentDate
						 AND n.ExpireDate >= @CurrentDate
						 AND ((@UserCanApprove = 1) OR (n.Approved = 1))
						 AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
						 AND n.HasPermissions = 1
						 AND n.PortalID = @PortalID
						 )
			END
					)
				)
		)
		END		
	 END AS ''Count''
	FROM 
	(SELECT 
	ncl.[CategoryID],
	ncl.[PortalID],
	ncl.[CategoryName],
	ncl.[Position],
	ncl.[ParentCategory],
	ncl.[Level],
	ncl.[CategoryURL],
	ncl.[CategoryImage],
	ncl.[CategoryText],
	ncl.Show,
		CASE WHEN cl.[NewsModuleID] IS NULL THEN @DefaultModuleID ELSE cl.[NewsModuleID] END AS NewsModuleID,
		CASE WHEN tm.[TabID] IS NULL THEN @DefaultTabID ELSE tm.[TabID] END AS TabID
	FROM @tempMenuCats as ncl LEFT OUTER JOIN [dbo].[EasyDNNNewsCategoryLink] as cl
	ON ncl.CategoryID = cl.CategoryID AND cl.[SourceModuleID] = @MenuModuleID
	LEFT OUTER JOIN {databaseOwner}{objectQualifier}TabModules AS tm ON cl.NewsModuleID = tm.ModuleID) as Result
	ORDER BY Position ASC, ParentCategory ASC	
END
ELSE IF @FilterByDNNUserID <> 0
BEGIN
SELECT *,
	CASE Show
	 WHEN 0 THEN 0
	 WHEN 1 THEN	
		CASE @AdminOrSuperUser
		WHEN 1 THEN
		(
		 SELECT count(n.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n	 
			 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON n.ArticleID = c.ArticleID AND c.CategoryID = Result.CategoryID
			 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
			 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
			 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
			 WHERE n.PublishDate <= @CurrentDate
			 AND n.ExpireDate >= @CurrentDate
			 AND n.PortalID = @PortalID
			 AND n.UserID = @FilterByDNNUserID 
		)
		WHEN 0 THEN
		(
		SELECT (
					(
						SELECT count(n.[ArticleID]) as cnt FROM [dbo].[EasyDNNNews] AS n
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON n.ArticleID = c.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
						 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
						 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
						 WHERE n.PublishDate <= @CurrentDate
							 AND n.ExpireDate >= @CurrentDate
							 AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							 AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							 AND n.HasPermissions = 0
							 AND n.PortalID = @PortalID
							 AND n.UserID = @FilterByDNNUserID
					)
					 +
					(
						SELECT count(aup.[ArticleID]) FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
						 INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
						 INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
						 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
						 WHERE ((@UserID = -1 AND aup.UserID IS NULL) OR (aup.UserID = @UserID))
					 		AND n.PublishDate <= @CurrentDate
							AND n.ExpireDate >= @CurrentDate
							AND ((@UserCanApprove = 1) OR (n.Approved = 1))
							AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
							AND n.HasPermissions = 1
							AND n.PortalID = @PortalID
							AND n.UserID = @FilterByDNNUserID 					 )	 
					+ 
					(
						CASE @UserID
						WHEN -1 THEN 0
						ELSE			
					(
						SELECT count(PerRoles.[ArticleID]) FROM 
						
						(SELECT DISTINCT arp.[ArticleID] FROM [dbo].[EasyDNNNewsArticleRolePermissions] as arp
						 INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = arp.ArticleID AND c.CategoryID = Result.CategoryID
						 INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = arp.ArticleID AND ncl.LocaleCode = @LocaleCode
						 WHERE arp.RoleID IN (SELECT RoleID FROM @UserInRoles)
						  AND arp.ArticleID NOT IN (
							SELECT aup.[ArticleID] FROM [dbo].[EasyDNNNewsArticleUserPermissions] AS aup
							INNER JOIN [dbo].[EasyDNNNewsCategories] AS c ON c.ArticleID = aup.ArticleID AND c.CategoryID = Result.CategoryID
							INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = aup.ArticleID
							INNER JOIN [dbo].[EasyDNNNewsSocialSecurity] AS nss ON nss.ArticleID = n.ArticleID
							INNER JOIN {databaseOwner}{objectQualifier}Journal_User_Permissions(@PortalId,@UserID, @FilterByDNNGroupID) as t ON t.seckey = nss.SecurityKey
							INNER JOIN [dbo].[EasyDNNNewsContentLocalization] AS ncl ON ncl.ArticleID = n.ArticleID AND ncl.LocaleCode = @LocaleCode
								WHERE aup.UserID = @UserID
					 				AND n.PublishDate <= @CurrentDate
									AND n.ExpireDate >= @CurrentDate
									AND ((@UserCanApprove = 1) OR (n.Approved = 1))
									AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
									AND n.HasPermissions = 1
									AND n.PortalID = @PortalID
									AND n.UserID = @FilterByDNNUserID 
			  				)
						 ) as PerRoles 
						 INNER JOIN [dbo].[EasyDNNNews] AS n ON n.ArticleID = PerRoles.ArticleID
						 WHERE n.PublishDate <= @CurrentDate
						 AND n.ExpireDate >= @CurrentDate
						 AND ((@UserCanApprove = 1) OR (n.Approved = 1))
						 AND ((@AdminOrSuperUser = 1) OR (n.Active = 1 OR n.UserID=@UserID))
						 AND n.HasPermissions = 1
						 AND n.PortalID = @PortalID
						 AND n.UserID = @FilterByDNNUserID 						 )
			END
					)
				)
		)
		END		
	 END AS ''Count''
	FROM 
	(SELECT 
	ncl.[CategoryID],
	ncl.[PortalID],
	ncl.[CategoryName],
	ncl.[Position],
	ncl.[ParentCategory],
	ncl.[Level],
	ncl.[CategoryURL],
	ncl.[CategoryImage],
	ncl.[CategoryText],
	ncl.Show,
		CASE WHEN cl.[NewsModuleID] IS NULL THEN @DefaultModuleID ELSE cl.[NewsModuleID] END AS NewsModuleID,
		CASE WHEN tm.[TabID] IS NULL THEN @DefaultTabID ELSE tm.[TabID] END AS TabID
	FROM @tempMenuCats as ncl LEFT OUTER JOIN [dbo].[EasyDNNNewsCategoryLink] as cl
	ON ncl.CategoryID = cl.CategoryID AND cl.[SourceModuleID] = @MenuModuleID
	LEFT OUTER JOIN {databaseOwner}{objectQualifier}TabModules AS tm ON cl.NewsModuleID = tm.ModuleID) as Result
	ORDER BY Position ASC, ParentCategory ASC
END

END

END' 
END
